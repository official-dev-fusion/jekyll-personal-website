<!doctype html>
<html class="no-js" lang="fr"> <!--<![endif]-->
    <head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Créer rapidement un projet de base complet avec un espace utilisateur et un back-office</title>
  <meta name="description" content="Depuis Symfony 4.0, il n’est plus nécessaire d’installer un bundle externe comme friendsofsymfony/user-bundle pour créer un espace utilisateur. En effet, le ...">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="manifest" href="site.webmanifest">
  <link rel="apple-touch-icon" href="/assets/img/icon.png">
  <!-- Place favicon.ico in the root directory -->

  <!-- HTML5 Boilerplate -->
  <link rel="stylesheet" href="/assets/css/normalize.css">
  <link rel="stylesheet" href="/assets/css/h5bp.css">

  <!-- Bootstrap 4 -->
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <!-- Author custom CSS -->
  <link rel="stylesheet" href="/assets/css/main.css">

  <link rel="canonical" href="http://localhost:4000/2019/11/01/creer-rapidement-un-projet-de-base-complet-avec-un-espace-utilisateur-et-un-back-office.html">
  <link rel="alternate" type="application/rss+xml" title="DevFusion" href="/feed.xml">
</head>

    <body>
        <!--[if lte IE 9]>
            <p class="browserupgrade">Vous utilisez un navigateur <strong>dépassé</strong>. S'il vous plaît <a href="https://browsehappy.com/">mettez à jour votre navigateur</a> pour améliorer votre expérience et votre sécurité.</p>
        <![endif]-->

        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    
    
    
    <a class="navbar-brand" href="/">DevFusion</a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
        <li class="nav-item">
            <a class="nav-link" href="/">Accueil</a>
        </li>
        
        
        
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/about/">À propos</a>
        </li>
        
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/blog">Blogue</a>
        </li>
        
        
        
        
        <li class="nav-item">
            <a class="nav-link" href="/cv">Curriculum Vitae - Martin GILBERT</a>
        </li>
        
        
        
        
        
        
        
        
        
        
        
    </div>
    
</nav>
        <main role="main">
  <div class="container">
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Créer rapidement un projet de base complet avec un espace utilisateur et un back-office</h1>
    <p class="post-meta">
      <time datetime="2019-11-01T20:28:00+01:00" itemprop="datePublished">
        
        01/11/2019
      </time>
      </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Depuis Symfony 4.0, il n’est plus nécessaire d’installer un bundle externe comme friendsofsymfony/user-bundle pour créer un espace utilisateur. En effet, le composant Security de Symfony est de plus en plus flexible, mais également plus simple. Pour exploiter toute sa puissance, on peut créer des Guard authenticators et des Voters pour faire des règles complexes d’autorisations. Malgré cela, il peut parfois être déroutant de créer rapidement un espace utilisateur grâce au composant Security vu toutes les possibilités qu’il nous offre.</p>

<p>L’équipe de Symfony a pensé à nous en ajoutant des commandes dans le maker-bundle, à partir de la version 1.8, afin de nous faciliter la tâche.</p>

<p>Voyons ensemble comment créer rapidement un projet de base complet avec un espace utilisateur et un back-office.</p>

<h2 id="commençons-par-créer-un-nouveau-projet-symfony-">Commençons par créer un nouveau projet Symfony :</h2>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">composer create-project symfony/website-skeleton dev_fusion_skeleton_user
</span></code></pre></div></div>
<hr />
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Installing symfony/website-skeleton (v4.3.99)
  - Installing symfony/website-skeleton (v4.3.99): Loading from cache
Created project in dev_fusion_skeleton_user
...
</code></pre></div></div>
<hr />

<h3 id="modifions-le-fichier-env-pour-configurer-la-base-de-données-et-créons-la">Modifions le fichier .env pour configurer la base de données et créons-la</h3>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>###&gt; doctrine/doctrine-bundle ###
DATABASE_URL=mysql://root:@127.0.0.1:3306/dev_fusion_skeleton_user
###&lt; doctrine/doctrine-bundle ###
</code></pre></div></div>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">php bin/console doctrine:database:create
</span></code></pre></div></div>
<hr />
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Created database `dev_fusion_skeleton_user` for connection named default
</code></pre></div></div>
<hr />

<p>Maintenant que nous avons un projet tout neuf, nous pouvons passer au sérieux.</p>

<h2 id="création-des-utilisateurs">Création des utilisateurs</h2>

<p>Nous allons créer une entité afin de pouvoir stocker nos utilisateurs et configurer le composant Security de Symfony avec cette entité.</p>

<p>Toutefois, rien de compliqué, il suffit juste de bien comprendre ce qui va être généré.</p>

<h3 id="pour-nous-faciliter-la-tâche-exécutons-la-première-commande-fournit-par-le-maker-bundle">Pour nous faciliter la tâche, exécutons la première commande fournit par le maker-bundle.</h3>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">php bin/console make:user
</span></code></pre></div></div>

<hr />
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code> The name of the security user class (e.g. User) [User]:
 &gt; User

 Do you want to store user data in the database (via Doctrine)? (yes/no) [yes]:
 &gt;

 Enter a property name that will be the unique "display" name for the user (e.g. email, username, uuid) [email]:
 &gt;

 Will this app need to hash/check user passwords? Choose No if passwords are not needed or will be checked/hashed by some other system (e.g. a single sign-on server).

 Does this app need to hash/check user passwords? (yes/no) [yes]:
 &gt;

 created: src/Entity/User.php
 created: src/Repository/UserRepository.php
 updated: src/Entity/User.php
 updated: config/packages/security.yaml


  Success!


 Next Steps:
   - Review your new App\Entity\User class.
   - Use make:entity to add more fields to your User entity and then run make:migration.
   - Create a way to authenticate! See https://symfony.com/doc/current/security.html
</code></pre></div></div>
<hr />

<p>Parfait, le maker-bundle, nous a créé une entité implémentant l’interface Symfony\Component\Security\Core\User\UserInterface et un UserRepository.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\User\UserInterface</span><span class="p">;</span>

<span class="sd">/**
 * @ORM\Entity(repositoryClass="App\Repository\UserRepository")
 */</span>
<span class="k">class</span> <span class="nc">User</span> <span class="k">implements</span> <span class="nx">UserInterface</span>
<span class="p">{</span>
    <span class="sd">/**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="string", length=180, unique=true)
     */</span>
    <span class="k">private</span> <span class="nv">$email</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="json")
     */</span>
    <span class="k">private</span> <span class="nv">$roles</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="sd">/**
     * @var string The hashed password
     * @ORM\Column(type="string")
     */</span>
    <span class="k">private</span> <span class="nv">$password</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">int</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getEmail</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setEmail</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$email</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * A visual identifier that represents this user.
     *
     * @see UserInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUsername</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @see UserInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getRoles</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
    <span class="p">{</span>
        <span class="nv">$roles</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">;</span>
        <span class="c1">// guarantee every user at least has ROLE_USER
</span>        <span class="nv">$roles</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'ROLE_USER'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nv">$roles</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setRoles</span><span class="p">(</span><span class="k">array</span> <span class="nv">$roles</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">roles</span> <span class="o">=</span> <span class="nv">$roles</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @see UserInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getPassword</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setPassword</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$password</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nv">$password</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @see UserInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSalt</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// not needed when using the "bcrypt" algorithm in security.yaml
</span>    <span class="p">}</span>

    <span class="sd">/**
     * @see UserInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">eraseCredentials</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// If you store any temporary, sensitive data on the user, clear it here
</span>        <span class="c1">// $this-&gt;plainPassword = null;
</span>    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Il a également mis à jour notre fichier security.yaml pour configurer un password encoder et un provider.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">security</span><span class="pi">:</span>
    <span class="na">encoders</span><span class="pi">:</span>
        <span class="s">App\Entity\User</span><span class="pi">:</span>
            <span class="na">algorithm</span><span class="pi">:</span> <span class="s">auto</span>

    <span class="c1"># https://symfony.com/doc/current/security.html#where-do-users-come-from-user-providers</span>
    <span class="na">providers</span><span class="pi">:</span>
        <span class="c1"># used to reload user from session &amp; other features (e.g. switch_user)</span>
        <span class="na">app_user_provider</span><span class="pi">:</span>
            <span class="na">entity</span><span class="pi">:</span>
                <span class="na">class</span><span class="pi">:</span> <span class="s">App\Entity\User</span>
                <span class="na">property</span><span class="pi">:</span> <span class="s">email</span>
</code></pre></div></div>

<p>Le code généré est bien commenté, nous pourrons continuer plus tard les modifications pour que ce soit plus représentatif de nos besoins.</p>

<h2 id="une-connexion-complète-avec-un-formulaire-en-une-commande">Une connexion complète avec un formulaire en une commande</h2>

<p>Maintenant que nous avons une classe pour nos utilisateurs, il est temps de les laisser se connecter. Vous voulez une connexion complète avec un formulaire en une commande ? Ce n’est pas un problème. La commande make:auth peut créer un système d’authentification de formulaire complet.</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">php bin/console make:auth
</span></code></pre></div></div>

<hr />
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code> What style of authentication do you want? [Empty authenticator]:
  [0] Empty authenticator
  [1] Login form authenticator
 &gt; 1

 The class name of the authenticator to create (e.g. AppCustomAuthenticator):
 &gt; LoginFormAuthenticator

 Choose a name for the controller class (e.g. SecurityController) [SecurityController]:
 &gt;

 Do you want to generate a '/logout' URL? (yes/no) [yes]:
 &gt;

 created: src/Security/LoginFormAuthenticator.php
 updated: config/packages/security.yaml
 created: src/Controller/SecurityController.php
 created: templates/security/login.html.twig


  Success!


 Next:
 - Customize your new authenticator.
 - Finish the redirect "TODO" in the App\Security\LoginFormAuthenticator::onAuthenticationSuccess() method.
 - Review &amp; adapt the login template: templates/security/login.html.twig.
</code></pre></div></div>
<hr />

<p>Cela crée la route de connexion, le contrôleur et le template ainsi qu’un  Guard authenticator qui gère
le login de connexion, inclut la protection CSRF et redirige intelligemment en cas de succès et d’erreur.</p>

<p>Le LoginFormAuthenticator a été correctement ajouté dans le firewalk main du fichier de configuration security.yaml. C’est donc cette classe qui va gérer l’authentification de nos utilisateurs.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="na">firewalls</span><span class="pi">:</span>
        <span class="s">...</span>
        <span class="s">main</span><span class="pi">:</span>
            <span class="na">anonymous</span><span class="pi">:</span> <span class="no">true</span>
            <span class="na">guard</span><span class="pi">:</span>
                <span class="na">authenticators</span><span class="pi">:</span>
                    <span class="pi">-</span> <span class="s">App\Security\LoginFormAuthenticator</span>
            <span class="na">logout</span><span class="pi">:</span>
                <span class="na">path</span><span class="pi">:</span> <span class="s">app_logout</span>
        <span class="err">```</span>
              
<span class="s">Quelques petite modification sont à effectuer à l'intérieur de notre classe d'authentification. Cependant, rien de bien compliqué.</span>

<span class="s">Nous avons un système de connexion entièrement fonctionnel en quelques minutes dans lequel nous avons le plein contrôle pour l'optimiser.</span>

<span class="s">Il nous faut maintenant donner à nos utilisateurs un moyen de s'enregistrer sur notre application.</span>

<span class="c1">## Inscription des utilisateurs</span>

<span class="s">Encore une fois le maker-bundle vient à notre secourt.</span>

<span class="err">```</span> <span class="s">console</span>
<span class="s">php bin/console make:registration-form</span>
</code></pre></div></div>

<hr />
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code> Creating a registration form for App\Entity\User

 Do you want to add a @UniqueEntity validation annotation on your User class to make sure duplicate accounts aren't created? (yes/no) [yes]:
 &gt;

 Do you want to automatically authenticate the user after registration? (yes/no) [yes]:
 &gt; no

 What route should the user be redirected to after registration?:
  [0 ] _twig_error_test
  [1 ] _wdt
  [2 ] _profiler_home
  [3 ] _profiler_search
  [4 ] _profiler_search_bar
  [5 ] _profiler_phpinfo
  [6 ] _profiler_search_results
  [7 ] _profiler_open_file
  [8 ] _profiler
  [9 ] _profiler_router
  [10] _profiler_exception
  [11] _profiler_exception_css
  [12] app_login
  [13] app_logout
 &gt; 12

 updated: src/Entity/User.php
 created: src/Form/RegistrationFormType.php
 created: src/Controller/RegistrationController.php
 created: templates/registration/register.html.twig


  Success!


 Next: Go to /register to check out your new form!
 Make any changes you need to the form, controller &amp; template.
</code></pre></div></div>
<hr />

<ul>
  <li>Nous ajoutons une validation unique sur l’email de nos utilisateurs.</li>
  <li>L’utilisateur n’est pas connecté automatiquement après l’inscription, car nous allons ajouter une confirmation par email.</li>
  <li>Après l’inscription l’utilisateur est redirigé sur le formulaire de connexion.</li>
</ul>

<h2 id="restructuration-du-projet-et-préparation-à-loptimisation">Restructuration du projet et préparation à l’optimisation</h2>

<p>La structure des répertoires doit être modifiée, car nous avons besoin d’un back et d’un front.</p>

<p>Par exemple, l’inscription sera utilisée seulement dans le front et nous allons plus tard créer un formulaire d’invitation pour les administrateurs qui sera utilisé seulement dans le back.</p>

<p>Nous allons créer des sous-dossiers back et front dans les dossiers templates, Controller et Form.</p>

<p>Controller
    -&gt; Back
    -&gt; Front</p>

<p>Form
    -&gt; Back
    -&gt; Front</p>

<p>templates
    -&gt; back
    -&gt; front</p>

<p>Les fonctionnalités communes au back et au front seront à la racine des répertoires templates, Controller et Form.</p>

<p>Par exemple, le login, le forget_password et le reset_password seront utilisés autant pour le back que pour le front.</p>

<h3 id="restructuration-des-dossiers">Restructuration des dossiers</h3>

<ul>
  <li>Dans le dossier Controller créer un sous-dossier Back et un autre Front;</li>
  <li>Dans le dossier Form créer un sous-dossier Back et un autre Front;</li>
  <li>Dans le dossier templates créer un sous-dossier back et un autre front;</li>
  <li>Déplacer le RegistrationFormType dans le sous-dossier Front et modifier le namespace: namespace App\Form\Front;</li>
  <li>Déplacer le RegistrationController dans le sous-dossier Front et modifier le namespace et le use du formulaire;</li>
  <li>Déplacer le dossier templates/registration dans un sous-dossier front et modifier le render de l’action register du contrôleur;</li>
</ul>

<h3 id="structure-des-templates">Structure des templates</h3>

<p>Maintenant, modifions nos templates afin de mieux présenter notre espace utilisateur.</p>

<h4 id="webpack-encore">Webpack Encore</h4>

<p>Nous allons utiliser Webpack Encore pour gérer plus efficacement le CSS et le Javascript de notre application.</p>

<p>Ça va nous donner un outil propre et puissant pour regrouper des modules JavaScript, CSS et JS et pour
compiler et minifier les assets.</p>

<p>Tout d’abord, assurez-vous que Node.js et Yarn sont installés sur votre machine.</p>

<p>Et ajouter le bundle webpack-encore:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">composer require symfony/webpack-encore-bundle
</span></code></pre></div></div>

<p>Ajouter les packages suivant :</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">yarn add node-sass sass-loader bootstrap @fortawesome/fontawesome-free @fortawesome/free-brands-svg-icons jquery popper.js --dev
</span></code></pre></div></div>

<p>Supprimer le fichier app.js dans le dossier assets/js/ et ajouter les deux fichiers suivants :</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// assets/js/front_app.js</span>

<span class="c1">// css</span>

<span class="k">import</span> <span class="s1">'../css/front_app.scss'</span><span class="p">;</span>

<span class="c1">// js</span>
<span class="kd">const</span> <span class="nx">$</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'jquery'</span><span class="p">);</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">Popper</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'popper.js'</span><span class="p">);</span>
<span class="nb">global</span><span class="p">.</span><span class="nx">$</span> <span class="o">=</span> <span class="nb">global</span><span class="p">.</span><span class="nx">jQuery</span> <span class="o">=</span> <span class="nx">$</span><span class="p">;</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">'bootstrap'</span><span class="p">);</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// assets/js/back_app.js</span>

<span class="c1">// css</span>
<span class="k">import</span> <span class="s1">'../css/back_app.scss'</span><span class="p">;</span>

<span class="c1">// js</span>
<span class="kd">const</span> <span class="nx">$</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'jquery'</span><span class="p">);</span>
<span class="nb">window</span><span class="p">.</span><span class="nx">Popper</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'popper.js'</span><span class="p">);</span>
<span class="nb">global</span><span class="p">.</span><span class="nx">$</span> <span class="o">=</span> <span class="nb">global</span><span class="p">.</span><span class="nx">jQuery</span> <span class="o">=</span> <span class="nx">$</span><span class="p">;</span>
<span class="nx">require</span><span class="p">(</span><span class="s1">'bootstrap'</span><span class="p">);</span>
</code></pre></div></div>

<p>Même principe dans le dossier assets/css :</p>

<div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// assets/css/front_app.scss
</span>
<span class="c1">// font awesome
</span><span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/fontawesome'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/regular'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/solid'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/brands'</span><span class="p">;</span>

<span class="c1">// bootstrap
</span><span class="k">@import</span> <span class="s2">"~bootstrap/scss/bootstrap"</span><span class="p">;</span>

<span class="nt">body</span> <span class="p">{</span>
    <span class="nn">#flash_message</span> <span class="p">{</span>
        <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
        <span class="nl">max-width</span><span class="p">:</span> <span class="m">320px</span><span class="p">;</span>
        <span class="nl">background-color</span><span class="p">:</span> <span class="nb">transparent</span><span class="p">;</span>
        <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
        <span class="nl">right</span><span class="p">:</span> <span class="m">15</span><span class="n">PX</span><span class="p">;</span>
        <span class="nl">top</span><span class="p">:</span> <span class="m">150px</span><span class="p">;</span>
        <span class="nl">z-index</span><span class="p">:</span> <span class="m">999</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-scss highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// assets/css/back_app.scss
</span>
<span class="c1">// font awesome
</span><span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/fontawesome'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/regular'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/solid'</span><span class="p">;</span>
<span class="k">@import</span> <span class="s1">'~@fortawesome/fontawesome-free/scss/brands'</span><span class="p">;</span>

<span class="c1">// bootstrap
</span><span class="k">@import</span> <span class="s2">"~bootstrap/scss/bootstrap"</span><span class="p">;</span>


<span class="c1">// global
</span>
<span class="nv">$base-font-size</span><span class="p">:</span> <span class="m">14px</span><span class="p">;</span>
<span class="nv">$default-color</span><span class="p">:</span> <span class="mh">#ff8a00</span><span class="p">;</span>
<span class="nv">$default-color-hover</span><span class="p">:</span><span class="mh">#fe9e08</span><span class="p">;</span>
<span class="nv">$default-color-auther</span><span class="p">:</span><span class="mh">#111</span><span class="p">;</span>
<span class="nv">$default-color-text</span><span class="p">:</span> <span class="mh">#777</span><span class="p">;</span>


<span class="nt">body</span> <span class="p">{</span>

    <span class="nc">.navbar</span> <span class="p">{</span>
        <span class="nl">padding</span><span class="p">:</span> <span class="m">15px</span> <span class="m">10px</span><span class="p">;</span>
        <span class="nl">background</span><span class="p">:</span> <span class="mh">#fff</span><span class="p">;</span>
        <span class="nl">border</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
        <span class="nl">border-radius</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
        <span class="nl">margin-bottom</span><span class="p">:</span> <span class="m">40px</span><span class="p">;</span>
        <span class="nl">box-shadow</span><span class="p">:</span> <span class="m">1px</span> <span class="m">1px</span> <span class="m">3px</span> <span class="nf">rgba</span><span class="p">(</span><span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="o">,</span> <span class="m">0</span><span class="mi">.1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nc">.navbar-btn</span> <span class="p">{</span>
        <span class="nl">box-shadow</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
        <span class="nl">outline</span><span class="p">:</span> <span class="nb">none</span> <span class="o">!</span><span class="n">important</span><span class="p">;</span>
        <span class="nl">border</span><span class="p">:</span> <span class="nb">none</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nc">.line</span> <span class="p">{</span>
        <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
        <span class="nl">height</span><span class="p">:</span> <span class="m">1px</span><span class="p">;</span>
        <span class="nl">border-bottom</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">dashed</span> <span class="mh">#ddd</span><span class="p">;</span>
        <span class="nl">margin</span><span class="p">:</span> <span class="m">40px</span> <span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nc">.btn</span> <span class="p">{</span>
        <span class="nl">border-radius</span><span class="p">:</span> <span class="m">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nc">.btn-info</span> <span class="p">{</span>
        <span class="nl">background-color</span><span class="p">:</span> <span class="nv">$default-color</span><span class="p">;</span>
        <span class="nl">border-color</span><span class="p">:</span> <span class="nv">$default-color</span><span class="p">;</span>
        <span class="k">&amp;</span><span class="nd">:hover</span><span class="p">{</span>
            <span class="nl">background-color</span><span class="p">:</span> <span class="nv">$default-color-hover</span><span class="p">;</span>
            <span class="nl">border-color</span><span class="p">:</span> <span class="nv">$default-color-hover</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nc">.btn-primary</span> <span class="p">{</span>
        <span class="nl">background-color</span><span class="p">:</span> <span class="nv">$default-color</span><span class="p">;</span>
        <span class="nl">border-color</span><span class="p">:</span> <span class="nv">$default-color</span><span class="p">;</span>
        <span class="k">&amp;</span><span class="nd">:hover</span><span class="p">{</span>
            <span class="nl">background-color</span><span class="p">:</span> <span class="nv">$default-color-hover</span><span class="p">;</span>
            <span class="nl">border-color</span><span class="p">:</span> <span class="nv">$default-color-hover</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nc">.wrapper</span> <span class="p">{</span>
        <span class="nl">display</span><span class="p">:</span> <span class="n">flex</span><span class="p">;</span>
        <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
        <span class="nl">align-items</span><span class="p">:</span> <span class="n">stretch</span><span class="p">;</span>
        <span class="nl">overflow</span><span class="p">:</span> <span class="nb">hidden</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nn">#sidebar</span> <span class="p">{</span>
        <span class="nl">min-width</span><span class="p">:</span> <span class="m">250px</span><span class="p">;</span>
        <span class="nl">max-width</span><span class="p">:</span> <span class="m">250px</span><span class="p">;</span>
        <span class="nl">background</span><span class="p">:</span> <span class="nv">$default-color-auther</span><span class="p">;</span>
        <span class="nl">color</span><span class="p">:</span> <span class="mh">#fff</span><span class="p">;</span>
        <span class="nl">transition</span><span class="p">:</span> <span class="n">all</span> <span class="m">0</span><span class="mi">.3s</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nn">#sidebar</span><span class="nc">.active</span> <span class="p">{</span>
        <span class="nl">margin-left</span><span class="p">:</span> <span class="m">-250px</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nn">#sidebar</span> <span class="nc">.sidebar-header</span> <span class="p">{</span>
        <span class="nl">padding</span><span class="p">:</span> <span class="m">20px</span><span class="p">;</span>
        <span class="nl">background</span><span class="p">:</span> <span class="nv">$default-color</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nn">#sidebar</span> <span class="nt">ul</span><span class="nc">.components</span> <span class="p">{</span>
        <span class="nl">padding</span><span class="p">:</span> <span class="m">20px</span> <span class="m">0</span><span class="p">;</span>
        <span class="nl">border-bottom</span><span class="p">:</span> <span class="m">1px</span> <span class="nb">solid</span> <span class="nv">$default-color</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nn">#sidebar</span> <span class="nt">ul</span> <span class="nt">p</span> <span class="p">{</span>
        <span class="nl">color</span><span class="p">:</span> <span class="mh">#fff</span><span class="p">;</span>
        <span class="nl">padding</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nn">#sidebar</span> <span class="nt">ul</span> <span class="nt">li</span> <span class="nt">a</span> <span class="p">{</span>
        <span class="nl">padding</span><span class="p">:</span> <span class="m">10px</span><span class="p">;</span>
        <span class="nl">font-size</span><span class="p">:</span> <span class="nf">rem</span><span class="p">(</span><span class="m">14</span><span class="p">);</span>
        <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
        <span class="nl">color</span><span class="p">:</span> <span class="mh">#fff</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nn">#sidebar</span> <span class="nt">ul</span> <span class="nt">li</span> <span class="nt">a</span><span class="nd">:hover</span> <span class="p">{</span>
        <span class="nl">color</span><span class="p">:</span> <span class="nv">$default-color-auther</span><span class="p">;</span>
        <span class="nl">background</span><span class="p">:</span> <span class="mh">#fff</span><span class="p">;</span>
        <span class="nl">color</span><span class="p">:</span> <span class="nv">$default-color</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nn">#sidebar</span> <span class="nt">ul</span> <span class="nt">li</span><span class="nc">.active</span><span class="o">&gt;</span><span class="nt">a</span><span class="o">,</span>
    <span class="nt">a</span><span class="o">[</span><span class="nt">aria-expanded</span><span class="o">=</span><span class="s2">"true"</span><span class="o">]</span> <span class="p">{</span>
        <span class="nl">color</span><span class="p">:</span> <span class="mh">#fff</span><span class="p">;</span>
        <span class="nl">background</span><span class="p">:</span> <span class="nv">$default-color</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">a</span><span class="o">[</span><span class="nt">data-toggle</span><span class="o">=</span><span class="s2">"collapse"</span><span class="o">]</span> <span class="p">{</span>
        <span class="nl">position</span><span class="p">:</span> <span class="nb">relative</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="err">.</span><span class="na">dropdown-toggle</span><span class="p">:</span><span class="o">:</span><span class="n">after</span> <span class="p">{</span>
        <span class="nl">display</span><span class="p">:</span> <span class="nb">block</span><span class="p">;</span>
        <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
        <span class="nl">top</span><span class="p">:</span> <span class="m">50%</span><span class="p">;</span>
        <span class="nl">right</span><span class="p">:</span> <span class="m">20px</span><span class="p">;</span>
        <span class="nl">transform</span><span class="p">:</span> <span class="nf">translateY</span><span class="p">(</span><span class="m">-50%</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nt">ul</span> <span class="nt">ul</span> <span class="nt">a</span> <span class="p">{</span>
        <span class="nl">font-size</span><span class="p">:</span> <span class="m">0</span><span class="mi">.9em</span> <span class="o">!</span><span class="n">important</span><span class="p">;</span>
        <span class="nl">padding-left</span><span class="p">:</span> <span class="m">30px</span> <span class="o">!</span><span class="n">important</span><span class="p">;</span>
        <span class="nl">background</span><span class="p">:</span> <span class="nv">$default-color</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="nt">a</span><span class="nc">.article</span><span class="o">,</span>
    <span class="nt">a</span><span class="nc">.article</span><span class="nd">:hover</span> <span class="p">{</span>
        <span class="nl">background</span><span class="p">:</span> <span class="nv">$default-color</span><span class="o">!</span><span class="n">important</span><span class="p">;</span>
        <span class="nl">color</span><span class="p">:</span> <span class="mh">#fff</span> <span class="o">!</span><span class="n">important</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nn">#flash_message</span> <span class="p">{</span>
        <span class="nl">width</span><span class="p">:</span> <span class="m">100%</span><span class="p">;</span>
        <span class="nl">max-width</span><span class="p">:</span> <span class="m">320px</span><span class="p">;</span>
        <span class="nl">background-color</span><span class="p">:</span> <span class="nb">transparent</span><span class="p">;</span>
        <span class="nl">position</span><span class="p">:</span> <span class="nb">absolute</span><span class="p">;</span>
        <span class="nl">right</span><span class="p">:</span> <span class="m">15px</span><span class="p">;</span>
        <span class="nl">top</span><span class="p">:</span> <span class="m">150px</span><span class="p">;</span>
        <span class="nl">z-index</span><span class="p">:</span> <span class="m">999</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Il faut également éditer le fichier webpack.config.js pour qu’il ressemble à celui-ci :</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">Encore</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'@symfony/webpack-encore'</span><span class="p">);</span>

<span class="nx">Encore</span>
    <span class="c1">// directory where compiled assets will be stored</span>
    <span class="p">.</span><span class="nx">setOutputPath</span><span class="p">(</span><span class="s1">'public/build/'</span><span class="p">)</span>
    <span class="c1">// public path used by the web server to access the output path</span>
    <span class="p">.</span><span class="nx">setPublicPath</span><span class="p">(</span><span class="s1">'/build'</span><span class="p">)</span>

    <span class="p">.</span><span class="nx">copyFiles</span><span class="p">({</span>
        <span class="na">from</span><span class="p">:</span> <span class="s1">'assets/img'</span><span class="p">,</span>
    
       <span class="c1">// optional target path, relative to the output dir</span>
        <span class="na">to</span><span class="p">:</span> <span class="s1">'images/[name].[hash:8].[ext]'</span><span class="p">,</span>
        
        <span class="c1">// if versioning is enabled, add the file hash too</span>
        <span class="c1">//to: 'images/[path][name].[hash:8].[ext]',</span>
        <span class="c1">// only copy files matching this pattern</span>
        <span class="na">pattern</span><span class="p">:</span> <span class="sr">/</span><span class="se">\.(</span><span class="sr">png|jpg|jpeg</span><span class="se">)</span><span class="sr">$/</span>
    <span class="p">})</span>

    <span class="cm">/*
     * ENTRY CONFIG
     *
     * Add 1 entry for each "page" of your app
     * (including one that's included on every page - e.g. "app")
     *
     * Each entry will result in one JavaScript file (e.g. app.js)
     * and one CSS file (e.g. app.css) if you JavaScript imports CSS.
     */</span>
    <span class="p">.</span><span class="nx">addEntry</span><span class="p">(</span><span class="s1">'back_app'</span><span class="p">,</span> <span class="s1">'./assets/js/back_app.js'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">addEntry</span><span class="p">(</span><span class="s1">'front_app'</span><span class="p">,</span> <span class="s1">'./assets/js/front_app.js'</span><span class="p">)</span>
    
    <span class="c1">// When enabled, Webpack "splits" your files into smaller pieces for greater optimization.</span>
    <span class="p">.</span><span class="nx">splitEntryChunks</span><span class="p">()</span>

    <span class="c1">// will require an extra script tag for runtime.js</span>
    <span class="c1">// but, you probably want this, unless you're building a single-page app</span>
    <span class="p">.</span><span class="nx">enableSingleRuntimeChunk</span><span class="p">()</span>

    <span class="cm">/*
     * FEATURE CONFIG
     *
     * Enable &amp; configure other features below. For a full
     * list of features, see:
     * https://symfony.com/doc/current/frontend.html#adding-more-features
     */</span>
    <span class="p">.</span><span class="nx">cleanupOutputBeforeBuild</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">enableBuildNotifications</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">enableSourceMaps</span><span class="p">(</span><span class="o">!</span><span class="nx">Encore</span><span class="p">.</span><span class="nx">isProduction</span><span class="p">())</span>
    <span class="c1">// enables hashed filenames (e.g. app.abc123.css)</span>
    <span class="p">.</span><span class="nx">enableVersioning</span><span class="p">(</span><span class="nx">Encore</span><span class="p">.</span><span class="nx">isProduction</span><span class="p">())</span>

    <span class="c1">// enables Sass/SCSS support</span>
    <span class="p">.</span><span class="nx">enableSassLoader</span><span class="p">()</span>

    <span class="c1">// uncomment if you're having problems with a jQuery plugin</span>
    <span class="p">.</span><span class="nx">autoProvidejQuery</span><span class="p">()</span>
<span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">Encore</span><span class="p">.</span><span class="nx">getWebpackConfig</span><span class="p">();</span>
</code></pre></div></div>

<p>La configuration de Webpack Encore est terminée et nous allons avoir une configuration pour le front et une autre pour le back de notre application afin d’avoir un visuel différent.</p>

<p>Il suffit de lancer une commande yarn pour générer le css et le js :</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">yarn encore dev
</span></code></pre></div></div>

<h4 id="base-et-layout-twig">Base et layout twig</h4>

<p>Voici maintenant le base.html.twig, le front/layout.html.twig et le back/layout.html.twig :</p>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"> 
<span class="c">{# templates/base.html.twig #}</span>
<span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"fr"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;head&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"UTF-8"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0,shrink-to-fit=no"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"author"</span> <span class="na">content=</span><span class="s">"Martin GILBERT"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;title&gt;</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{{</span> <span class="s1">'DevFusion'</span> <span class="cp">}}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="nt">&lt;/title&gt;</span>
        <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"description"</span> <span class="na">content=</span><span class="s">"</span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">description</span> <span class="cp">%}{{</span> <span class="s1">''</span> <span class="cp">}}{%</span> <span class="k">endblock</span> <span class="cp">%}</span><span class="s">"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"icon"</span> <span class="na">type=</span><span class="s">"image/png"</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">asset</span><span class="p">(</span><span class="s1">'build/images/favicon.png'</span><span class="p">)</span><span class="cp">}}</span><span class="s">"</span> <span class="nt">/&gt;</span>
        <span class="cp">{%</span> <span class="k">block</span> <span class="nv">stylesheets</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
    <span class="nt">&lt;/head&gt;</span>
    <span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="nt">&lt;/html&gt;</span>
 </code></pre></figure>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"> 
<span class="c">{# template/back/layout.html.twig #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html.twig'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">stylesheets</span> <span class="cp">%}</span>
    <span class="cp">{{</span><span class="nv">encore_entry_link_tags</span><span class="p">(</span><span class="s1">'back_app'</span><span class="p">)</span><span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="cp">{%</span> <span class="k">block</span> <span class="nv">flash_message</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">include</span> <span class="s2">"block/_flash_message.html.twig"</span> <span class="cp">%}</span>
        <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"wrapper"</span><span class="nt">&gt;</span>
            <span class="cp">{%</span> <span class="k">block</span> <span class="nv">sidebar</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">include</span> <span class="s2">"back/block/_sidebar.html.twig"</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
            <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"content"</span><span class="nt">&gt;</span>
                <span class="cp">{%</span> <span class="k">block</span> <span class="nv">navbar</span> <span class="cp">%}</span>
                    <span class="cp">{%</span> <span class="k">include</span> <span class="s2">"back/block/_navbar.html.twig"</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
        <span class="cp">{%</span> <span class="k">block</span> <span class="nv">javascripts</span> <span class="cp">%}</span>
            <span class="cp">{{</span><span class="nv">encore_entry_script_tags</span><span class="p">(</span><span class="s1">'back_app'</span><span class="p">)</span><span class="cp">}}</span>
        <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
 </code></pre></figure>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"> 
<span class="c">{# template/front/layout.html.twig #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'base.html.twig'</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">stylesheets</span> <span class="cp">%}</span>
    <span class="cp">{{</span> <span class="nv">encore_entry_link_tags</span><span class="p">(</span><span class="s1">'front_app'</span><span class="p">)</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">body</span> <span class="cp">%}</span>
    <span class="nt">&lt;body&gt;</span>
        <span class="cp">{%</span> <span class="k">block</span> <span class="nv">flash_message</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">include</span> <span class="s2">"block/_flash_message.html.twig"</span> <span class="cp">%}</span>
        <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
        
        <span class="cp">{%</span> <span class="k">block</span> <span class="nv">navbar</span> <span class="cp">%}</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"menu"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
                    <span class="cp">{%</span> <span class="k">include</span> <span class="s2">"front/block/_navbar.html.twig"</span> <span class="cp">%}</span>
                <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

        <span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">block</span> <span class="nv">banner</span><span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
        <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

        <span class="cp">{%</span> <span class="k">block</span> <span class="nv">footer</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">include</span> <span class="s2">"front/block/_footer.html.twig"</span> <span class="cp">%}</span>
        <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

        <span class="cp">{%</span> <span class="k">block</span> <span class="nv">javascripts</span> <span class="cp">%}</span>
            <span class="cp">{{</span> <span class="nv">encore_entry_script_tags</span><span class="p">(</span><span class="s1">'front_app'</span><span class="p">)</span> <span class="cp">}}</span>
        <span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
    <span class="nt">&lt;/body&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
 </code></pre></figure>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"> 
<span class="c">{# templates/block/_flash_message.html.twig #}</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">app.request.hasPreviousSession</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">set</span> <span class="nv">flashbag</span> <span class="err">=</span> <span class="nv">app.session.flashbag.all</span><span class="p">()</span> <span class="cp">%}</span>
    <span class="cp">{%</span> <span class="k">if</span> <span class="nv">flashbag</span><span class="o">|</span><span class="nf">length</span> <span class="cp">%}</span>
        <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"flash_message"</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
            <span class="cp">{%</span> <span class="k">for</span> <span class="nv">type</span><span class="p">,</span> <span class="nv">messages</span> <span class="ow">in</span> <span class="nv">flashbag</span> <span class="cp">%}</span>
                <span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="ow">in</span> <span class="nv">messages</span> <span class="cp">%}</span>
                    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-</span><span class="cp">{{</span> <span class="nv">type</span> <span class="cp">}}</span><span class="s"> alert-dismissible fade show"</span> <span class="na">role=</span><span class="s">"alert"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="p">(</span><span class="s1">'alert.'</span> <span class="err">~</span> <span class="nv">type</span><span class="p">)</span><span class="o">|</span><span class="nf">trans</span><span class="p">(</span><span class="err">{}</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">)</span> <span class="cp">}}</span> : <span class="nt">&lt;/span&gt;</span><span class="cp">{{</span> <span class="nv">message</span><span class="o">|</span><span class="nf">raw</span><span class="o">|</span><span class="nf">nl2br</span> <span class="cp">}}</span>
                        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">class=</span><span class="s">"close"</span> <span class="na">data-dismiss=</span><span class="s">"alert"</span> <span class="na">aria-label=</span><span class="s">"</span><span class="cp">{{</span> <span class="s1">'btn.close'</span><span class="o">|</span><span class="nf">trans</span><span class="p">(</span><span class="err">{}</span><span class="p">,</span> <span class="s1">'message'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;span</span> <span class="na">aria-hidden=</span><span class="s">"true"</span><span class="nt">&gt;</span><span class="ni">&amp;times;</span><span class="nt">&lt;/span&gt;</span>
                        <span class="nt">&lt;/button&gt;</span>
                    <span class="nt">&lt;/div&gt;</span>
                <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
            <span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
 </code></pre></figure>

<p>Vous pouvez pour l’instant, ajouter des fichiers vides pour les includes dans les répertoires back/block &amp; front/block…</p>

<h3 id="accueil-back-et-front">Accueil Back et Front</h3>

<p>Ajoutons un contrôleur Page avec une action index et un template dans le back et le front afin d’accueillir nos utilisateurs.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Controller\Back</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\AbstractController</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing\Annotation\Route</span><span class="p">;</span>

<span class="sd">/**
 * @Route("/back")
 */</span>
<span class="k">class</span> <span class="nc">PageController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="sd">/**
     * @Route("/", name="back_home")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'back/page/index.html.twig'</span><span class="p">,</span> <span class="p">[</span>
            
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Controller\Front</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\AbstractController</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing\Annotation\Route</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">PageController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>
    <span class="sd">/**
     * @Route("/", name="front_home")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">index</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'front/page/index.html.twig'</span><span class="p">,</span> <span class="p">[</span>
            
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"><span class="c">{# templates/back/page/index.html.twig #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'back/layout.html.twig'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="nt">&lt;p&gt;</span>Page d'accueil back<span class="nt">&lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"><span class="c">{# templates/front/page/index.html.twig #}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'front/layout.html.twig'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
    <span class="nt">&lt;p&gt;</span>Page d'accueil front<span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span><span class="cp">{{</span> <span class="nv">app.user.lastLoginAt</span><span class="o">|</span><span class="nf">date</span><span class="p">()</span> <span class="cp">}}</span><span class="nt">&lt;/p&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span></code></pre></figure>

<p>Notre structure Symfony est maintenant mieux divisée afin de facilement s’y retrouver.</p>

<p>Nous sommes maintenant prêts pour optimiser notre espace utilisateur.</p>

<h2 id="modification-de-lentité-user">Modification de l’entité User</h2>

<p>Nous allons ajouter quelques éléments à notre entité User afin de pouvoir par la suite implémenter de nouvelles fonctionnalités.</p>

<ul>
  <li>Modification du message d’erreur de l’email unique par une constante de traduction registration.message.unique_email. (Je vous fournis les fichiers de traduction à la fin)</li>
  <li>Un champ firstname et un champ lastname de type string afin de mieux identifier nos utilisateurs;</li>
  <li>Un champ enabled de type boolean pour activer et désactiver le compte utilisateur;</li>
  <li>Un champ confirmationToken de type string afin d’identifier l’utilisateur pour contrôler l’email lors de l’inscription ou l’invitation et pour envoyer un courriel si l’utilisateur oublie son mot de passe;</li>
  <li>Un champ lastLoginAt de type DateTime;</li>
  <li>Un champ createdAt de type DateTime;</li>
  <li>Un champ updatedAt de type DateTime;</li>
  <li>Une méthode __toString pour convertir l’objet en chaîne de caractères;</li>
  <li>Une méthode setCreated liée à l’événement PrePersist de Doctrine;</li>
  <li>Une méthode setUpdated liée à l’événement PreUpdate de Doctrine;</li>
</ul>

<p>Voici le résultat final :</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bridge\Doctrine\Validator\Constraints\UniqueEntity</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\User\UserInterface</span><span class="p">;</span>

<span class="sd">/**
 * @ORM\Entity(repositoryClass="App\Repository\UserRepository")
 * @UniqueEntity(fields={"email"}, message="registration.message.unique_email")
 * @ORM\HasLifecycleCallbacks()
 */</span>
<span class="k">class</span> <span class="nc">User</span> <span class="k">implements</span> <span class="nx">UserInterface</span>
<span class="p">{</span>
    <span class="sd">/**
     * @ORM\Id()
     * @ORM\GeneratedValue()
     * @ORM\Column(type="integer")
     */</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="string", length=180, unique=true)
     */</span>
    <span class="k">private</span> <span class="nv">$email</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="json")
     */</span>
    <span class="k">private</span> <span class="nv">$roles</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="sd">/**
     * @var string The hashed password
     * @ORM\Column(type="string")
     */</span>
    <span class="k">private</span> <span class="nv">$password</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="boolean")
     */</span>
    <span class="k">private</span> <span class="nv">$enabled</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="string", length=255, nullable=true)
     */</span>
    <span class="k">private</span> <span class="nv">$confirmationToken</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="string", length=255, nullable=true)
     */</span>
    <span class="k">private</span> <span class="nv">$firstname</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="string", length=255, nullable=true)
     */</span>
    <span class="k">private</span> <span class="nv">$lastname</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="datetime", nullable=true)
     */</span>
    <span class="k">private</span> <span class="nv">$lastLoginAt</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="datetime")
     */</span>
    <span class="k">private</span> <span class="nv">$createdAt</span><span class="p">;</span>

    <span class="sd">/**
     * @ORM\Column(type="datetime")
     */</span>
    <span class="k">private</span> <span class="nv">$updatedAt</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__toString</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">ucfirst</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getFirstname</span><span class="p">())</span><span class="o">.</span><span class="s2">" "</span><span class="o">.</span><span class="nb">mb_strtoupper</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getLastname</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @ORM\PrePersist
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setCreated</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setCreatedAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setUpdatedAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @ORM\PreUpdate
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUpdated</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">setUpdatedAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getId</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">int</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getEmail</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setEmail</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$email</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span> <span class="o">=</span> <span class="nv">$email</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * A visual identifier that represents this user.
     *
     * @see UserInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUsername</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">email</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">hasRole</span><span class="p">(</span><span class="nv">$role</span><span class="p">)</span><span class="o">:</span> <span class="nx">bool</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">in_array</span><span class="p">(</span><span class="nb">strtoupper</span><span class="p">(</span><span class="nv">$role</span><span class="p">),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getRoles</span><span class="p">(),</span> <span class="kc">true</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @see UserInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getRoles</span><span class="p">()</span><span class="o">:</span> <span class="k">array</span>
    <span class="p">{</span>
        <span class="nv">$roles</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">roles</span><span class="p">;</span>
        <span class="c1">// guarantee every user at least has ROLE_USER
</span>        <span class="nv">$roles</span><span class="p">[]</span> <span class="o">=</span> <span class="s1">'ROLE_USER'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nb">array_unique</span><span class="p">(</span><span class="nv">$roles</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setRoles</span><span class="p">(</span><span class="k">array</span> <span class="nv">$roles</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">roles</span> <span class="o">=</span> <span class="nv">$roles</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @see UserInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getPassword</span><span class="p">()</span><span class="o">:</span> <span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setPassword</span><span class="p">(</span><span class="nx">string</span> <span class="nv">$password</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nv">$password</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @see UserInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">getSalt</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// not needed when using the "bcrypt" algorithm in security.yaml
</span>    <span class="p">}</span>

    <span class="sd">/**
     * @see UserInterface
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">eraseCredentials</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// If you store any temporary, sensitive data on the user, clear it here
</span>        <span class="c1">// $this-&gt;plainPassword = null;
</span>    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">isEnabled</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">bool</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">enabled</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getEnabled</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">bool</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">enabled</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setEnabled</span><span class="p">(</span><span class="nx">bool</span> <span class="nv">$enabled</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">enabled</span> <span class="o">=</span> <span class="nv">$enabled</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getConfirmationToken</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">confirmationToken</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setConfirmationToken</span><span class="p">(</span><span class="o">?</span><span class="nx">string</span> <span class="nv">$confirmationToken</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">confirmationToken</span> <span class="o">=</span> <span class="nv">$confirmationToken</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getFirstname</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">firstname</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setFirstname</span><span class="p">(</span><span class="o">?</span><span class="nx">string</span> <span class="nv">$firstname</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">firstname</span> <span class="o">=</span> <span class="nv">$firstname</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getLastname</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">string</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lastname</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setLastname</span><span class="p">(</span><span class="o">?</span><span class="nx">string</span> <span class="nv">$lastname</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lastname</span> <span class="o">=</span> <span class="nv">$lastname</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getLastLoginAt</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">\DateTimeInterface</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lastLoginAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setLastLoginAt</span><span class="p">(</span><span class="o">?</span><span class="nx">\DateTimeInterface</span> <span class="nv">$lastLoginAt</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">lastLoginAt</span> <span class="o">=</span> <span class="nv">$lastLoginAt</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCreatedAt</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">\DateTimeInterface</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createdAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setCreatedAt</span><span class="p">(</span><span class="nx">\DateTimeInterface</span> <span class="nv">$createdAt</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createdAt</span> <span class="o">=</span> <span class="nv">$createdAt</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUpdatedAt</span><span class="p">()</span><span class="o">:</span> <span class="o">?</span><span class="nx">\DateTimeInterface</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatedAt</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUpdatedAt</span><span class="p">(</span><span class="nx">\DateTimeInterface</span> <span class="nv">$updatedAt</span><span class="p">)</span><span class="o">:</span> <span class="nx">self</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatedAt</span> <span class="o">=</span> <span class="nv">$updatedAt</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Mettons à jour le schéma de base de données :</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">php bin/console doctrine:schema:update --force
</span></code></pre></div></div>

<h2 id="amélioration-du-loginformauthenticator">Amélioration du LoginFormAuthenticator</h2>

<ul>
  <li>Injection du composant de traduction afin de traduire les messages d’erreur;</li>
  <li>Injection de la session pour envoyer des messages flash;</li>
  <li>Ajout d’une erreur à la connexion si l’utilisateur n’est pas activé;</li>
  <li>Lors de la connexion redirection dans le back si l’utilisateur a le rôle admin;</li>
  <li>Mise à jour de la date de connexion de l’utilisateur;</li>
  <li>Ajout d’un message de bienvenue après la connexion;</li>
</ul>

<p>Voici le résultat final :</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Security</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManagerInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\RedirectResponse</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing\Generator\UrlGeneratorInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Authentication\Token\TokenInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Exception\CustomUserMessageAuthenticationException</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Encoder\UserPasswordEncoderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Exception\InvalidCsrfTokenException</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Security</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\User\UserInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\User\UserProviderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Csrf\CsrfToken</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Csrf\CsrfTokenManagerInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Guard\Authenticator\AbstractFormLoginAuthenticator</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Http\Util\TargetPathTrait</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Session\SessionInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Translation\TranslatorInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">LoginFormAuthenticator</span> <span class="k">extends</span> <span class="nx">AbstractFormLoginAuthenticator</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">TargetPathTrait</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$entityManager</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$urlGenerator</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$csrfTokenManager</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$passwordEncoder</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$session</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$translator</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">EntityManagerInterface</span> <span class="nv">$entityManager</span><span class="p">,</span> <span class="nx">UrlGeneratorInterface</span> <span class="nv">$urlGenerator</span><span class="p">,</span> <span class="nx">CsrfTokenManagerInterface</span> <span class="nv">$csrfTokenManager</span><span class="p">,</span> <span class="nx">UserPasswordEncoderInterface</span> <span class="nv">$passwordEncoder</span><span class="p">,</span> <span class="nx">SessionInterface</span> <span class="nv">$session</span><span class="p">,</span> <span class="nx">TranslatorInterface</span> <span class="nv">$translator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urlGenerator</span> <span class="o">=</span> <span class="nv">$urlGenerator</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csrfTokenManager</span> <span class="o">=</span> <span class="nv">$csrfTokenManager</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">passwordEncoder</span> <span class="o">=</span> <span class="nv">$passwordEncoder</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span> <span class="o">=</span> <span class="nv">$session</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span> <span class="o">=</span> <span class="nv">$translator</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">supports</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="s1">'app_login'</span> <span class="o">===</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">attributes</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'_route'</span><span class="p">)</span>
            <span class="o">&amp;&amp;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">isMethod</span><span class="p">(</span><span class="s1">'POST'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCredentials</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$credentials</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'email'</span><span class="p">),</span>
            <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'password'</span><span class="p">),</span>
            <span class="s1">'csrf_token'</span> <span class="o">=&gt;</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'_csrf_token'</span><span class="p">),</span>
        <span class="p">];</span>
        <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getSession</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">set</span><span class="p">(</span>
            <span class="nx">Security</span><span class="o">::</span><span class="na">LAST_USERNAME</span><span class="p">,</span>
            <span class="nv">$credentials</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$credentials</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getUser</span><span class="p">(</span><span class="nv">$credentials</span><span class="p">,</span> <span class="nx">UserProviderInterface</span> <span class="nv">$userProvider</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$token</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CsrfToken</span><span class="p">(</span><span class="s1">'authenticate'</span><span class="p">,</span> <span class="nv">$credentials</span><span class="p">[</span><span class="s1">'csrf_token'</span><span class="p">]);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">csrfTokenManager</span><span class="o">-&gt;</span><span class="na">isTokenValid</span><span class="p">(</span><span class="nv">$token</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">InvalidCsrfTokenException</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">findOneBy</span><span class="p">([</span><span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="nv">$credentials</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]]);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// fail authentication with a custom error
</span>            <span class="k">throw</span> <span class="k">new</span> <span class="nx">CustomUserMessageAuthenticationException</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span><span class="o">-&gt;</span><span class="na">trans</span><span class="p">(</span><span class="s1">'login.message.email_not_found'</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">'security'</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">isEnabled</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">CustomUserMessageAuthenticationException</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span><span class="o">-&gt;</span><span class="na">trans</span><span class="p">(</span><span class="s1">'login.message.not_activated'</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">'security'</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$user</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">checkCredentials</span><span class="p">(</span><span class="nv">$credentials</span><span class="p">,</span> <span class="nx">UserInterface</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">passwordEncoder</span><span class="o">-&gt;</span><span class="na">isPasswordValid</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$credentials</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">onAuthenticationSuccess</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">TokenInterface</span> <span class="nv">$token</span><span class="p">,</span> <span class="nv">$providerKey</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$targetPath</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getTargetPath</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">getSession</span><span class="p">(),</span> <span class="nv">$providerKey</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span><span class="nv">$targetPath</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$token</span><span class="o">-&gt;</span><span class="na">getUser</span><span class="p">();</span>
        
        <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setLastLoginAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">());</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
        
        <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span><span class="o">-&gt;</span><span class="na">trans</span><span class="p">(</span><span class="s1">'login.message.welcome'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'%user%'</span> <span class="o">=&gt;</span> <span class="nv">$user</span> <span class="p">],</span> <span class="s1">'security'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">session</span><span class="o">-&gt;</span><span class="na">getFlashBag</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">);</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="o">-&gt;</span><span class="na">hasRole</span><span class="p">(</span><span class="s1">'ROLE_ADMIN'</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urlGenerator</span><span class="o">-&gt;</span><span class="na">generate</span><span class="p">(</span><span class="s1">'back_home'</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urlGenerator</span><span class="o">-&gt;</span><span class="na">generate</span><span class="p">(</span><span class="s1">'front_home'</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">getLoginUrl</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">urlGenerator</span><span class="o">-&gt;</span><span class="na">generate</span><span class="p">(</span><span class="s1">'app_login'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="amélioration-de-linscription">Amélioration de l’inscription</h2>

<ul>
  <li>Ajout de la traduction;</li>
  <li>Ajout de messages flash;</li>
  <li>Envoi d’un courriel pour valider l’adresse mail de l’utilisateur</li>
</ul>

<h3 id="ajout-de-paramètres">Ajout de paramètres</h3>

<p>Pour définir les informations du site web, nous allons ajouter des paramètres dans le fichier services.yaml:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">parameters</span><span class="pi">:</span>
    <span class="na">configuration</span><span class="pi">:</span>
        <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">DevFusion"</span>
        <span class="na">from_email</span><span class="pi">:</span> <span class="s">no-reply@dev-fusion.com</span>
        <span class="na">to_email</span><span class="pi">:</span> <span class="s">martin.gilbert@dev-fusion.com</span>
</code></pre></div></div>

<h3 id="envoi-de-lemail-de-confirmation-avec-swiftmailer">Envoi de l’email de confirmation avec SwiftMailer</h3>

<p>Ajoutons une classe pour gérer l’envoi de mail:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">App\Mailer</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Symfony\Component\Routing\Generator\UrlGeneratorInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Templating\EngineInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Translation\TranslatorInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\DependencyInjection\ParameterBag\ParameterBagInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Entity\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Repository\UserRepository</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Mailer</span>
<span class="p">{</span>
    
    <span class="sd">/**
     * @var MailerInterface
     */</span>
    <span class="k">protected</span> <span class="nv">$mailer</span><span class="p">;</span>
    
    <span class="sd">/**
     * @var UrlGeneratorInterface
     */</span>
    <span class="k">protected</span> <span class="nv">$router</span><span class="p">;</span>
    
    <span class="sd">/**
     * @var EngineInterface
     */</span>
    <span class="k">protected</span> <span class="nv">$templating</span><span class="p">;</span>
    
    <span class="sd">/**
     * @var TranslatorInterface
     */</span>
    <span class="k">protected</span> <span class="nv">$translator</span><span class="p">;</span>
    
    <span class="sd">/**
     * @var ParameterBagInterface
     */</span>
    <span class="k">protected</span> <span class="nv">$parameters</span><span class="p">;</span>
    
    <span class="sd">/**
     * Mailer constructor.
     *
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">\Swift_Mailer</span> <span class="nv">$mailer</span><span class="p">,</span> <span class="nx">UrlGeneratorInterface</span> <span class="nv">$router</span><span class="p">,</span> <span class="nx">EngineInterface</span> <span class="nv">$templating</span><span class="p">,</span> <span class="nx">TranslatorInterface</span> <span class="nv">$translator</span><span class="p">,</span> <span class="nx">ParameterBagInterface</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mailer</span> <span class="o">=</span> <span class="nv">$mailer</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router</span> <span class="o">=</span> <span class="nv">$router</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">templating</span> <span class="o">=</span> <span class="nv">$templating</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span> <span class="o">=</span> <span class="nv">$translator</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parameters</span> <span class="o">=</span> <span class="nv">$parameters</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="k">public</span> <span class="k">function</span> <span class="nf">sendRegistration</span><span class="p">(</span><span class="nx">User</span> <span class="nv">$user</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$url</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router</span><span class="o">-&gt;</span><span class="na">generate</span><span class="p">(</span>
            <span class="s1">'app_registration_confirm'</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="s1">'token'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getConfirmationToken</span><span class="p">(),</span>
            <span class="p">],</span>
            <span class="nx">UrlGeneratorInterface</span><span class="o">::</span><span class="na">ABSOLUTE_URL</span>
        <span class="p">);</span>
        <span class="nv">$subject</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span><span class="o">-&gt;</span><span class="na">trans</span><span class="p">(</span><span class="s1">'registration.email.subject'</span><span class="p">,</span> <span class="p">[</span> <span class="s1">'%user%'</span> <span class="o">=&gt;</span> <span class="nv">$user</span> <span class="p">],</span> <span class="s1">'security'</span><span class="p">);</span>
        <span class="nv">$template</span> <span class="o">=</span> <span class="s1">'front/email/register.html.twig'</span><span class="p">;</span>
        <span class="nv">$from</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parameters</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'configuration.'</span><span class="p">)[</span><span class="s1">'from_email'</span><span class="p">]</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parameters</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'configuration'</span><span class="p">)[</span><span class="s1">'name'</span><span class="p">],</span>
        <span class="p">];</span>
        <span class="nv">$to</span> <span class="o">=</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getEmail</span><span class="p">();</span>
        <span class="nv">$body</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">templating</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="nv">$template</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'user'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">,</span>
            <span class="s1">'website_name'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parameters</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'configuration'</span><span class="p">)[</span><span class="s1">'name'</span><span class="p">],</span>
            <span class="s1">'confirmation_url'</span> <span class="o">=&gt;</span> <span class="nv">$url</span><span class="p">,</span>
        <span class="p">]);</span>
        <span class="nv">$message</span> <span class="o">=</span> <span class="p">(</span><span class="k">new</span> <span class="nx">\Swift_Message</span><span class="p">())</span>
            <span class="o">-&gt;</span><span class="na">setSubject</span><span class="p">(</span><span class="nv">$subject</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setFrom</span><span class="p">(</span><span class="nv">$from</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setTo</span><span class="p">(</span><span class="nv">$to</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setContentType</span><span class="p">(</span><span class="s2">"text/html"</span><span class="p">)</span>
            <span class="o">-&gt;</span><span class="na">setBody</span><span class="p">(</span><span class="nv">$body</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mailer</span><span class="o">-&gt;</span><span class="na">send</span><span class="p">(</span><span class="nv">$message</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Il faut configurer le moteur de template pour injecter twig dans le service mailer.</p>

<p>Exécuter cette commande:</p>
<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">composer require symfony/templating
</span></code></pre></div></div>

<p>Et dans le fichier framework.yaml ajouter cette ligne :</p>

<figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"> 
<span class="na">framework</span><span class="pi">:</span>
    <span class="na">templating</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">engines</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">twig'</span><span class="pi">]</span> <span class="pi">}</span></code></pre></figure>

<p>Et maintenant le template de l’email d’inscription</p>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"> 
<span class="c">{# templates/front/email/register.html.twig #}</span>
<span class="cp">{{</span> <span class="s1">'registration.email.message'</span><span class="o">|</span><span class="nf">trans</span><span class="p">(</span><span class="err">{</span>
        <span class="s1">'%user%'</span><span class="err">:</span> <span class="nv">user</span><span class="p">,</span>
        <span class="s1">'%confirmation_url%'</span><span class="err">:</span> <span class="nv">confirmation_url</span><span class="p">,</span>
        <span class="s1">'%host%'</span><span class="err">:</span> <span class="nv">app.request.schemeAndHttpHost</span><span class="p">,</span>
        <span class="s1">'%website_name%'</span><span class="err">:</span> <span class="nv">website_name</span>
    <span class="err">}</span><span class="p">,</span> <span class="s1">'security'</span><span class="p">)</span><span class="o">|</span><span class="nf">raw</span><span class="o">|</span><span class="nf">nl2br</span>
<span class="cp">}}</span></code></pre></figure>

<p>Il ne reste plus qu’à créer le texte de l’email dans le fichier de traduction.</p>

<h3 id="le-registrationcontroller">Le RegistrationController</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Controller\Front</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Form\Front\RegistrationFormType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Mailer\Mailer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\AbstractController</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing\Annotation\Route</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Encoder\UserPasswordEncoderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Translation\TranslatorInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RegistrationController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>

    <span class="sd">/**
     * @var TranslatorInterface
     */</span>
    <span class="k">private</span> <span class="nv">$translator</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">TranslatorInterface</span> <span class="nv">$translator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span> <span class="o">=</span> <span class="nv">$translator</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="sd">/**
     * @Route("/register", name="front_register")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">UserPasswordEncoderInterface</span> <span class="nv">$passwordEncoder</span><span class="p">,</span> <span class="nx">Mailer</span> <span class="nv">$mailer</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="nx">RegistrationFormType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="nv">$user</span><span class="p">);</span>
        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">handleRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isSubmitted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// encode the plain password
</span>            <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setPassword</span><span class="p">(</span>
                <span class="nv">$passwordEncoder</span><span class="o">-&gt;</span><span class="na">encodePassword</span><span class="p">(</span>
                    <span class="nv">$user</span><span class="p">,</span>
                    <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'plainPassword'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">);</span>

            <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setEnabled</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
            <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setConfirmationToken</span><span class="p">(</span><span class="nb">random_bytes</span><span class="p">(</span><span class="mi">24</span><span class="p">));</span>
            <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setLastLoginAt</span><span class="p">(</span><span class="k">new</span> <span class="nx">\DateTime</span><span class="p">());</span>
            
            <span class="nv">$entityManager</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">();</span>
            <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
            <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

            <span class="nv">$mailer</span><span class="o">-&gt;</span><span class="na">sendRegistration</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>

            <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span><span class="o">-&gt;</span><span class="na">trans</span><span class="p">(</span><span class="s1">'registration.flash.check_email'</span><span class="p">,</span> <span class="p">[</span> <span class="s1">'%email%'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">getEmail</span><span class="p">(),</span> <span class="p">],</span> <span class="s1">'security'</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFlash</span><span class="p">(</span><span class="s1">'info'</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">);</span>

            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirectToRoute</span><span class="p">(</span><span class="s1">'app_login'</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'front/registration/register.html.twig'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">(),</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="le-formulaire-dinscription">Le formulaire d’inscription</h3>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Form\Front</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\AbstractType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Extension\Core\Type\CheckboxType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Extension\Core\Type\EmailType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Extension\Core\Type\PasswordType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Extension\Core\Type\RepeatedType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Extension\Core\Type\TextType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\FormBuilderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\OptionsResolver\OptionsResolver</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Validator\Constraints\NotBlank</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Validator\Constraints\Length</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Validator\Constraints\IsTrue</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">RegistrationFormType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilderInterface</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$builder</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="nx">EmailType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'registration.label.email'</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'firstname'</span><span class="p">,</span> <span class="nx">TextType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'registration.label.firstname'</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'lastname'</span><span class="p">,</span> <span class="nx">TextType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'registration.label.lastname'</span><span class="p">,</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'plainPassword'</span><span class="p">,</span> <span class="nx">RepeatedType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">PasswordType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
                <span class="s1">'invalid_message'</span> <span class="o">=&gt;</span> <span class="s1">'registration.message.repeated_password_invalid'</span><span class="p">,</span>
                <span class="s1">'options'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'attr'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="s1">'password-field'</span><span class="p">]],</span>
                <span class="s1">'required'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
                <span class="s1">'first_options'</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'registration.label.password'</span><span class="p">],</span>
                <span class="s1">'second_options'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'registration.label.repeat_password'</span><span class="p">],</span>
                <span class="c1">// instead of being set onto the object directly,
</span>                <span class="c1">// this is read and encoded in the controller
</span>                <span class="s1">'mapped'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
                <span class="s1">'constraints'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="k">new</span> <span class="nx">NotBlank</span><span class="p">([</span>
                        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'registration.message.password_not_blank'</span><span class="p">,</span>
                    <span class="p">]),</span>
                    <span class="k">new</span> <span class="nx">Length</span><span class="p">([</span>
                        <span class="s1">'min'</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="s1">'minMessage'</span> <span class="o">=&gt;</span> <span class="s1">'registration.message.password_length_min'</span><span class="p">,</span>
                        <span class="c1">// max length allowed by Symfony for security reasons
</span>                        <span class="s1">'max'</span> <span class="o">=&gt;</span> <span class="mi">4096</span><span class="p">,</span>
                    <span class="p">]),</span>
                <span class="p">],</span>
            <span class="p">])</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'agreeTerms'</span><span class="p">,</span> <span class="nx">CheckboxType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'registration.label.agree_terms'</span><span class="p">,</span>
                <span class="s1">'mapped'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
                <span class="s1">'constraints'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="k">new</span> <span class="nx">IsTrue</span><span class="p">([</span>
                        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'registration.message.agree_terms_is_true'</span><span class="p">,</span>
                    <span class="p">]),</span>
                <span class="p">],</span>
            <span class="p">])</span>
        <span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">configureOptions</span><span class="p">(</span><span class="nx">OptionsResolver</span> <span class="nv">$resolver</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$resolver</span><span class="o">-&gt;</span><span class="na">setDefaults</span><span class="p">([</span>
            <span class="s1">'data_class'</span> <span class="o">=&gt;</span> <span class="nx">User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
            <span class="s1">'translation_domain'</span> <span class="o">=&gt;</span> <span class="s1">'security'</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h3 id="la-vue-dinscription">La vue d’inscription</h3>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"><span class="c">{# templates/front/registration/register.html.twig #}</span>
<span class="cp">{%</span> <span class="nv">trans_default_domain</span> <span class="s1">'security'</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'front/layout.html.twig'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{{</span> <span class="s1">'registration.title'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"pt-4 pb-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-lg-6 mx-auto"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card mt-4 mb-4"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body"</span><span class="nt">&gt;</span>
                    <span class="cp">{{</span> <span class="nv">form_start</span><span class="p">(</span><span class="nv">form</span><span class="p">)</span> <span class="cp">}}</span>
                        <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"h3 mb-3 font-weight-normal"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="s1">'registration.h1'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span>
                        <span class="cp">{{</span> <span class="nv">form_row</span><span class="p">(</span><span class="nv">form.email</span><span class="p">)</span> <span class="cp">}}</span>
                        <span class="cp">{{</span> <span class="nv">form_row</span><span class="p">(</span><span class="nv">form.firstname</span><span class="p">)</span> <span class="cp">}}</span>
                        <span class="cp">{{</span> <span class="nv">form_row</span><span class="p">(</span><span class="nv">form.lastname</span><span class="p">)</span> <span class="cp">}}</span>
                        <span class="cp">{{</span> <span class="nv">form_row</span><span class="p">(</span><span class="nv">form.plainPassword</span><span class="p">)</span> <span class="cp">}}</span>
                        <span class="cp">{{</span> <span class="nv">form_row</span><span class="p">(</span><span class="nv">form.agreeTerms</span><span class="p">)</span> <span class="cp">}}</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group text-center"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn btn-primary btn-block"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
                                <span class="cp">{{</span> <span class="s1">'registration.btn.submit'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                            <span class="nt">&lt;/button&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                    <span class="cp">{{</span> <span class="nv">form_end</span><span class="p">(</span><span class="nv">form</span><span class="p">)</span> <span class="cp">}}</span>
                <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/section&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span></code></pre></figure>

<p>Pour améliorer la vue de nos formulaires nous pouvons ajouter le thème Bootstrap4:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/packages/twig.yaml</span>
<span class="na">twig</span><span class="pi">:</span>
    <span class="s">...</span>
    <span class="s">form_themes</span><span class="pi">:</span> <span class="pi">[</span><span class="s1">'</span><span class="s">bootstrap_4_layout.html.twig'</span><span class="pi">]</span>
</code></pre></div></div>

<h3 id="la-confirmation-du-compte">La confirmation du compte</h3>

<p>Une fois l’email envoyé avec le token de confirmation, il faut créer une action de contrôleur pour activer l’utilisateur.</p>

<p>Nous allons donc ajouter une méthode registrationConfirm dans le contrôleur SecurityController dans laquelle nous allons :</p>

<ul>
  <li>Récupérer le token de la requête;</li>
  <li>Rechercher l’utilisateur à partir du token;</li>
  <li>Si l’utilisateur n’existe pas, on retourne un statut 404;</li>
  <li>On set le token de l’utilisateur à null pour qu’il ne soit pas réutilisé, on active l’utilisateur et on le flush avec Doctrine;</li>
  <li>On envoie un message flash pour indiquer que le compte a bien été activé.</li>
  <li>Et finalement, on connecte l’utilisateur et on le redirige en déclenchant l’événement authenticateUserAndHandleSuccess;</li>
</ul>

<p>Voici l’état de notre contrôleur:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Controller</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Form\ForgetPasswordFormType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Form\ResetPasswordFormType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Mailer\Mailer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Repository\UserRepository</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Bundle\FrameworkBundle\Controller\AbstractController</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\EventDispatcher\EventDispatcherInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Request</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpFoundation\Response</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Routing\Annotation\Route</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Authentication\Provider\UserAuthenticationProvider</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Http\Authentication\AuthenticationUtils</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Exception\LogicException</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Translation\TranslatorInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Encoder\UserPasswordEncoderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Guard\GuardAuthenticatorHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Security\LoginFormAuthenticator</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">SecurityController</span> <span class="k">extends</span> <span class="nx">AbstractController</span>
<span class="p">{</span>

    <span class="sd">/**
     * @var TranslatorInterface
     */</span>
    <span class="k">private</span> <span class="nv">$translator</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">TranslatorInterface</span> <span class="nv">$translator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span> <span class="o">=</span> <span class="nv">$translator</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="sd">/**
     * @Route("/login", name="app_login")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">login</span><span class="p">(</span><span class="nx">AuthenticationUtils</span> <span class="nv">$authenticationUtils</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="c1">// if ($this-&gt;getUser()) {
</span>        <span class="c1">//    $this-&gt;redirectToRoute('target_path');
</span>        <span class="c1">// }
</span>
        <span class="c1">// get the login error if there is one
</span>        <span class="nv">$error</span> <span class="o">=</span> <span class="nv">$authenticationUtils</span><span class="o">-&gt;</span><span class="na">getLastAuthenticationError</span><span class="p">();</span>
        <span class="c1">// last username entered by the user
</span>        <span class="nv">$lastUsername</span> <span class="o">=</span> <span class="nv">$authenticationUtils</span><span class="o">-&gt;</span><span class="na">getLastUsername</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'security/login.html.twig'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'last_username'</span> <span class="o">=&gt;</span> <span class="nv">$lastUsername</span><span class="p">,</span> <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="nv">$error</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @Route("/logout", name="app_logout")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">logout</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">\Exception</span><span class="p">(</span><span class="s1">'This method can be blank - it will be intercepted by the logout key on your firewall'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**
     * @Route("/registration_confirm", name="app_registration_confirm")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">registrationConfirm</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">UserRepository</span> <span class="nv">$userRepository</span><span class="p">,</span> <span class="nx">GuardAuthenticatorHandler</span> <span class="nv">$guardHandler</span><span class="p">,</span> <span class="nx">LoginFormAuthenticator</span> <span class="nv">$authenticator</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">query</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'token'</span><span class="p">);</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userRepository</span><span class="o">-&gt;</span><span class="na">findOneByConfirmationToken</span><span class="p">(</span><span class="nv">$token</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="kc">null</span> <span class="o">===</span> <span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNotFoundException</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">'The user with confirmation token "%s" does not exist'</span><span class="p">,</span> <span class="nv">$token</span><span class="p">));</span>
        <span class="p">}</span>
        
        <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setConfirmationToken</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
        <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setEnabled</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
        
        <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span><span class="o">-&gt;</span><span class="na">trans</span><span class="p">(</span><span class="s1">'registration.flash.confirmed'</span><span class="p">,</span> <span class="p">[</span> <span class="s1">'%user%'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">,</span> <span class="p">],</span> <span class="s1">'security'</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFlash</span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">);</span>
        
        <span class="k">return</span> <span class="nv">$guardHandler</span><span class="o">-&gt;</span><span class="na">authenticateUserAndHandleSuccess</span><span class="p">(</span>
            <span class="nv">$user</span><span class="p">,</span>
            <span class="nv">$request</span><span class="p">,</span>
            <span class="nv">$authenticator</span><span class="p">,</span>
            <span class="s1">'main'</span> <span class="c1">// firewall name in security.yaml
</span>        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>Et voilà, tout est réglé concernant la vérification de l’adresse email.</p>

<h2 id="jai-oublié-mon-mot-de-passe">J’ai oublié mon mot de passe</h2>

<p>Au nombre de mot de passe dont on doit se souvenir pour chacun des services qu’on utilise au quotidien, il est normal d’en oublier un une fois de temps en temps. C’est donc une fonctionnalité indispensable.</p>

<p>Nous allons créer une page dans laquelle l’utilisateur pourra entrer son email. À la soumission de ce formulaire, un mail lui sera envoyé dans lequel il y aura un lien avec un token pour qu’il puisse réinitialiser son mot de passe.</p>

<p>La page de réinitialisation aura un double usage:</p>

<ul>
  <li>Les utilisateurs ayant oublié leur mot de passe qui vont donc s’identifier avec un token reçu par mail;</li>
  <li>Les utilisateurs voulant simplement changer leur mot de passe pour une raison de sécurité qui vont devoir entrer leur ancien mot de passe;</li>
</ul>

<h3 id="identification-avec-un-token">Identification avec un token</h3>

<p>Nous allons ajouter une action forgetPassword dans le contrôleur Security:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="sd">/**
     * @Route("/forget_password", name="app_forget_password")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">forgetPassword</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nx">UserRepository</span> <span class="nv">$userRepository</span><span class="p">,</span> <span class="nx">Mailer</span> <span class="nv">$mailer</span><span class="p">)</span><span class="o">:</span> <span class="nx">Response</span>
    <span class="p">{</span>
        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="nx">ForgetPasswordFormType</span><span class="o">::</span><span class="na">class</span><span class="p">);</span>
        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">handleRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isSubmitted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userRepository</span><span class="o">-&gt;</span><span class="na">findOneByEmail</span><span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'email'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">());</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setConfirmationToken</span><span class="p">(</span><span class="nb">random_bytes</span><span class="p">(</span><span class="mi">24</span><span class="p">));</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
                <span class="nv">$mailer</span><span class="o">-&gt;</span><span class="na">sendForgetPassword</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
                <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span><span class="o">-&gt;</span><span class="na">trans</span><span class="p">(</span><span class="s1">'forget_password.flash.check_email'</span><span class="p">,</span> <span class="p">[</span> <span class="s1">'%user%'</span> <span class="o">=&gt;</span> <span class="nv">$user</span><span class="p">,</span> <span class="p">],</span> <span class="s1">'security'</span><span class="p">);</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFlash</span><span class="p">(</span><span class="s1">'success'</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirectToRoute</span><span class="p">(</span><span class="s1">'front_home'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'security/forget_password.html.twig'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">(),</span>
        <span class="p">]);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Cette action reste simple :</p>

<ul>
  <li>On crée un formulaire pour inscrire l’adresse email;</li>
  <li>On recherche l’utilisateur à partir de son email;</li>
  <li>S’il existe, ajout d’un token, envoie de l’email et ajout d’un message flash;</li>
  <li>Sinon, on ne fait rien du tout;</li>
  <li>Et redirection sur la page d’accueil;</li>
</ul>

<p>Les templates, le formulaire, et l’envoie de l’email est trop simple pour que je vous montre le code. C’est exactement comme pour l’inscription.</p>

<h2 id="réinitialisation-du-mot-de-passe">Réinitialisation du mot de passe</h2>

<p>Lorsqu’un utilisateur est connecté, il peut redéfinir son mot de passe.</p>

<p>Voici l’action du contrôleur permettant de le faire. J’explique le fonctionnement juste après.</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="sd">/**
     * @Route("/reset_password/{id}", defaults={"id"=null}, name="app_reset_password")
     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">resetPassword</span><span class="p">(</span>
        <span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span>
        <span class="nx">UserRepository</span> <span class="nv">$userRepository</span><span class="p">,</span>
        <span class="nx">UserPasswordEncoderInterface</span> <span class="nv">$passwordEncoder</span><span class="p">,</span>
        <span class="nx">GuardAuthenticatorHandler</span> <span class="nv">$guardHandler</span><span class="p">,</span>
        <span class="nx">LoginFormAuthenticator</span> <span class="nv">$authenticator</span><span class="p">,</span>
        <span class="nx">User</span> <span class="nv">$user</span><span class="o">=</span><span class="kc">null</span>
    <span class="p">)</span><span class="o">:</span> <span class="nx">response</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$token</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">query</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'token'</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userRepository</span><span class="o">-&gt;</span><span class="na">findOneByConfirmationToken</span><span class="p">(</span><span class="nv">$token</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createNotFoundException</span><span class="p">(</span><span class="nb">sprintf</span><span class="p">(</span><span class="s1">'The user with confirmation token "%s" does not exist'</span><span class="p">,</span> <span class="nv">$token</span><span class="p">));</span> <span class="p">}</span>
        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="o">!</span><span class="nv">$user</span><span class="p">)</span> <span class="p">{</span> <span class="k">throw</span> <span class="k">new</span> <span class="nx">LogicException</span><span class="p">(</span><span class="s2">"No user selected."</span><span class="p">);</span> <span class="p">}</span>
        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="nx">ResetPasswordFormType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'with_token'</span> <span class="o">=&gt;</span> <span class="kc">null</span> <span class="o">!==</span> <span class="nv">$token</span><span class="p">,</span>
        <span class="p">]);</span>
        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">handleRequest</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isSubmitted</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setPassword</span><span class="p">(</span><span class="nv">$passwordEncoder</span><span class="o">-&gt;</span><span class="na">encodePassword</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'plainPassword'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getData</span><span class="p">()));</span>
            <span class="k">if</span> <span class="p">(</span><span class="nv">$token</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setConfirmationToken</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getDoctrine</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getManager</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>
            <span class="nv">$msg</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">translator</span><span class="o">-&gt;</span><span class="na">trans</span><span class="p">(</span><span class="s1">'reset_password.flash.success'</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">'security'</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">addFlash</span><span class="p">(</span><span class="s1">'info'</span><span class="p">,</span> <span class="nv">$msg</span><span class="p">);</span>
            <span class="k">return</span> <span class="nv">$guardHandler</span><span class="o">-&gt;</span><span class="na">authenticateUserAndHandleSuccess</span><span class="p">(</span><span class="nv">$user</span><span class="p">,</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$authenticator</span><span class="p">,</span> <span class="s1">'main'</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="s1">'security/reset_password.html.twig'</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'form'</span> <span class="o">=&gt;</span> <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">createView</span><span class="p">(),</span>
        <span class="p">]);</span>
    <span class="p">}</span>
</code></pre></div></div>

<p>Cette action est un peu longue. Il faut dire qu’elle a deux rôles. Redéfinir le mot de passe d’un utilisateur connecté ou d’un utilisateur ayant oublié son mot de passe avec un token reçu par mail.</p>

<p>Tout d’abord l’id dans la route est facultatif, car l’utilisateur peut également être récupéré avec un token dans le cas d’un oubli de mot de passe.</p>

<p>S’il y a un token, on essaie de récupérer l’utilisateur à partir de celui-ci, mais s’il n’y a aucune correspondance, on n’oublie pas de déclencher une erreur 404.</p>

<p>S’il n’y a pas de token et que la variable $user est nulle, on déclenche une LogicException.</p>

<p>De cette manière, on s’assure que pour la suite la variable $user est initialisée soit par le ParamConverter ou par la méthode magique findOneByConfirmationToken du repository.</p>

<p>Ensuite, on crée un formulaire en spécifiant l’option with_token pour préciser s’il faut demander l’ancien mot de passe ou pas.</p>

<p>Si c’est une requête POST et que le formulaire est valide :</p>

<ul>
  <li>On encode le nouveau mot de passe et on remplace l’ancien par celui-ci;</li>
  <li>On supprime le token de confirmation si c’est une identification envoyée par e-mail;</li>
  <li>On enregistre les modifications dans la base de données;</li>
  <li>On ajoute un message flash pour confirmer que tout c’est bien passé;</li>
  <li>On connecte l’utilisateur avec le GuardHandler et s’il l’était déjà, il sera simplement redirigé au bonne endroit.</li>
</ul>

<p>Et sinon, on renvoie une réponse avec la vue security/reset_password.html.twig comme contenu.</p>

<p>Le formulaire se présente ainsi:</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">App\Form</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Entity\User</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\AbstractType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Extension\Core\Type\PasswordType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\Extension\Core\Type\RepeatedType</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Form\FormBuilderInterface</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\OptionsResolver\OptionsResolver</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Security\Core\Validator\Constraints\UserPassword</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Validator\Constraints\NotBlank</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Validator\Constraints\Length</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ResetPasswordFormType</span> <span class="k">extends</span> <span class="nx">AbstractType</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">buildForm</span><span class="p">(</span><span class="nx">FormBuilderInterface</span> <span class="nv">$builder</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$options</span><span class="p">[</span><span class="s1">'with_token'</span><span class="p">])</span> <span class="p">{</span>
            <span class="nv">$builder</span>
                <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span> <span class="nx">PasswordType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span>
                    <span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'reset_password.label.current_password'</span><span class="p">,</span>
                    <span class="s1">'constraints'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                        <span class="k">new</span> <span class="nx">NotBlank</span><span class="p">([</span>
                            <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'registration.message.not_blank'</span><span class="p">,</span>
                        <span class="p">]),</span>
                        <span class="k">new</span> <span class="nx">Length</span><span class="p">([</span>
                            <span class="s1">'min'</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span>
                            <span class="s1">'minMessage'</span> <span class="o">=&gt;</span> <span class="s1">'registration.message.password_length_min'</span><span class="p">,</span>
                            <span class="c1">// max length allowed by Symfony for security reasons
</span>                            <span class="s1">'max'</span> <span class="o">=&gt;</span> <span class="mi">4096</span><span class="p">,</span>
                        <span class="p">]),</span>
                        <span class="k">new</span> <span class="nx">UserPassword</span><span class="p">([</span>
                            <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'reset_password.message.current_password_wrong'</span><span class="p">,</span>
                        <span class="p">])</span>
                    <span class="p">],</span>
                <span class="p">])</span>
            <span class="p">;</span>
        <span class="p">}</span>
        <span class="nv">$builder</span>
            <span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="s1">'plainPassword'</span><span class="p">,</span> <span class="nx">RepeatedType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span> <span class="p">[</span>
                <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="nx">PasswordType</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
                <span class="s1">'invalid_message'</span> <span class="o">=&gt;</span> <span class="s1">'reset_password.message.repeated_new_password_invalid'</span><span class="p">,</span>
                <span class="s1">'options'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'attr'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'class'</span> <span class="o">=&gt;</span> <span class="s1">'password-field'</span><span class="p">]],</span>
                <span class="s1">'required'</span> <span class="o">=&gt;</span> <span class="kc">true</span><span class="p">,</span>
                <span class="s1">'first_options'</span>  <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'reset_password.label.new_password'</span><span class="p">],</span>
                <span class="s1">'second_options'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'label'</span> <span class="o">=&gt;</span> <span class="s1">'reset_password.label.repeat_new_password'</span><span class="p">],</span>
                <span class="c1">// instead of being set onto the object directly,
</span>                <span class="c1">// this is read and encoded in the controller
</span>                <span class="s1">'mapped'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
                <span class="s1">'constraints'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="k">new</span> <span class="nx">NotBlank</span><span class="p">([</span>
                        <span class="s1">'message'</span> <span class="o">=&gt;</span> <span class="s1">'registration.message.password_not_blank'</span><span class="p">,</span>
                    <span class="p">]),</span>
                    <span class="k">new</span> <span class="nx">Length</span><span class="p">([</span>
                        <span class="s1">'min'</span> <span class="o">=&gt;</span> <span class="mi">6</span><span class="p">,</span>
                        <span class="s1">'minMessage'</span> <span class="o">=&gt;</span> <span class="s1">'registration.message.password_length_min'</span><span class="p">,</span>
                        <span class="c1">// max length allowed by Symfony for security reasons
</span>                        <span class="s1">'max'</span> <span class="o">=&gt;</span> <span class="mi">4096</span><span class="p">,</span>
                    <span class="p">]),</span>
                <span class="p">],</span>
            <span class="p">])</span>
        <span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">configureOptions</span><span class="p">(</span><span class="nx">OptionsResolver</span> <span class="nv">$resolver</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$resolver</span><span class="o">-&gt;</span><span class="na">setDefaults</span><span class="p">([</span>
            <span class="s1">'with_token'</span> <span class="o">=&gt;</span> <span class="kc">false</span><span class="p">,</span>
            <span class="s1">'translation_domain'</span> <span class="o">=&gt;</span> <span class="s1">'security'</span><span class="p">,</span>
        <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Et finalement la vue du formulaire :</p>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"><span class="c">{# templates/security/reset_password.html.twig #}</span>
<span class="cp">{%</span> <span class="nv">trans_default_domain</span> <span class="s1">'security'</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'front/layout.html.twig'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{{</span> <span class="s1">'reset_password.title'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"pt-4 pb-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-lg-6 mx-auto"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card mt-4 mb-4"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body"</span><span class="nt">&gt;</span>
                    <span class="cp">{{</span> <span class="nv">form_start</span><span class="p">(</span><span class="nv">form</span><span class="p">)</span> <span class="cp">}}</span>
                        <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"h3 mb-3 font-weight-normal"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="s1">'reset_password.h1'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span>
                        <span class="cp">{%</span> <span class="k">if</span> <span class="nv">form.password</span> <span class="ow">is</span> <span class="nb">defined</span> <span class="cp">%}</span>
                            <span class="cp">{{</span> <span class="nv">form_row</span><span class="p">(</span><span class="nv">form.password</span><span class="p">)</span> <span class="cp">}}</span>
                        <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
                        <span class="cp">{{</span> <span class="nv">form_row</span><span class="p">(</span><span class="nv">form.plainPassword</span><span class="p">)</span> <span class="cp">}}</span>
                        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group text-center"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn btn-primary btn-block"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
                                <span class="cp">{{</span> <span class="s1">'reset_password.btn.submit'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                            <span class="nt">&lt;/button&gt;</span>
                        <span class="nt">&lt;/div&gt;</span>
                    <span class="cp">{{</span> <span class="nv">form_end</span><span class="p">(</span><span class="nv">form</span><span class="p">)</span> <span class="cp">}}</span>
                <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/section&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span></code></pre></figure>

<h2 id="le-formulaire-de-login-et-le-menu">Le formulaire de login et le menu</h2>

<p>Nous avons presque terminé, il nous manque juste une petite fonctionnalité.</p>

<p>Une fois qu’un utilisateur est authentifié, les informations d’identification sont stockées dans la session. À la fin de celle-ci, il est déconnecté et il doit fournir à nouveau ses identifiants la prochaine fois qu’il souhaite accéder à l’application.</p>

<p>L’équipe de Symfony a encore pensé à tout pour nous. Il est possible de créer facilement une case à cocher dans le formulaire de login pour rester connecté. Un token sera stocker dans les cookies de l’utilisateur pour qu’il puisse se connecter automatiquement à son retour.</p>

<p>Il suffit d’ajouter l’option  remember_me dans le firewalk:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># config/packages/security.yaml</span>
<span class="na">security</span><span class="pi">:</span>
    <span class="c1"># ...</span>

    <span class="na">firewalls</span><span class="pi">:</span>
        <span class="na">main</span><span class="pi">:</span>
            <span class="c1"># ...</span>
            <span class="na">remember_me</span><span class="pi">:</span>
                <span class="na">secret</span><span class="pi">:</span>   <span class="s1">'</span><span class="s">%kernel.secret%'</span>
                <span class="na">lifetime</span><span class="pi">:</span> <span class="s">604800</span> <span class="c1"># 1 week in seconds</span>
                <span class="na">path</span><span class="pi">:</span>     <span class="s">/</span>
                <span class="c1">#always_remember_me: true</span>
</code></pre></div></div>

<p>Et voici ce que nous donne au final notre formulaire de login :</p>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"><span class="c">{# templates/security/login.html.twig #}</span>
<span class="cp">{%</span> <span class="nv">trans_default_domain</span> <span class="s1">'security'</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">extends</span> <span class="s1">'front/layout.html.twig'</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}{{</span> <span class="s1">'login.title'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="nt">&lt;section</span> <span class="na">class=</span><span class="s">"pt-4 pb-4"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"container"</span><span class="nt">&gt;</span>
        <span class="cp">{%</span> <span class="k">if</span> <span class="nv">error</span> <span class="cp">%}</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"fadeInDown animated"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"alert alert-danger"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="nv">error.messageKey</span><span class="o">|</span><span class="nf">trans</span><span class="p">(</span><span class="nv">error.messageData</span><span class="p">,</span> <span class="s1">'security'</span><span class="p">)</span> <span class="cp">}}</span><span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-lg-6 mx-auto"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card mt-4 mb-4"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"card-body"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;form</span> <span class="na">method=</span><span class="s">"post"</span><span class="nt">&gt;</span>
                        <span class="cp">{%</span> <span class="k">if</span> <span class="nv">app.user</span> <span class="cp">%}</span>
                            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"mb-3"</span><span class="nt">&gt;</span>
                                <span class="cp">{{</span> <span class="s1">'login.message.logged_as'</span><span class="o">|</span><span class="nf">trans</span><span class="p">(</span><span class="err">{</span> <span class="s1">'%user%'</span><span class="err">:</span> <span class="nv">app.user</span> <span class="err">}</span><span class="p">)</span> <span class="cp">}}</span>, <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'app_logout'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="s1">'login.link.logout'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="nt">&lt;/a&gt;</span>
                            <span class="nt">&lt;/div&gt;</span>
                        <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
                            <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"h3 mb-3 font-weight-normal"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="s1">'login.h1'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span>
                            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputEmail"</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="s1">'login.label.email'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="nt">&lt;/label&gt;</span>
                            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"email"</span> <span class="na">value=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">last_username</span> <span class="cp">}}</span><span class="s">"</span> <span class="na">name=</span><span class="s">"email"</span> <span class="na">id=</span><span class="s">"inputEmail"</span> <span class="na">class=</span><span class="s">"form-control mb-2"</span> <span class="na">placeholder=</span><span class="s">"</span><span class="cp">{{</span> <span class="s1">'login.label.email'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="s">"</span> <span class="na">required</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">"inputPassword"</span> <span class="na">class=</span><span class="s">"sr-only"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="s1">'login.label.password'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="nt">&lt;/label&gt;</span>
                            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"password"</span> <span class="na">name=</span><span class="s">"password"</span> <span class="na">id=</span><span class="s">"inputPassword"</span> <span class="na">class=</span><span class="s">"form-control"</span> <span class="na">placeholder=</span><span class="s">"</span><span class="cp">{{</span> <span class="s1">'login.label.password'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="s">"</span> <span class="na">required</span><span class="nt">&gt;</span>

                            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"hidden"</span> <span class="na">name=</span><span class="s">"_csrf_token"</span>
                                <span class="na">value=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">csrf_token</span><span class="p">(</span><span class="s1">'authenticate'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span>
                            <span class="nt">&gt;</span>
                            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"checkbox mb-3"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;label&gt;</span>
                                    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"checkbox"</span> <span class="na">name=</span><span class="s">"_remember_me"</span><span class="nt">&gt;</span> <span class="cp">{{</span> <span class="s1">'login.label.remember_me'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                                <span class="nt">&lt;/label&gt;</span>
                            <span class="nt">&lt;/div&gt;</span>
                            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"form-group text-center"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"btn btn-primary btn-block"</span> <span class="na">type=</span><span class="s">"submit"</span><span class="nt">&gt;</span>
                                    <span class="cp">{{</span> <span class="s1">'login.btn.submit'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                                <span class="nt">&lt;/button&gt;</span>
                            <span class="nt">&lt;/div&gt;</span>
                            <span class="nt">&lt;hr&gt;</span>
                            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"row"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-6"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'app_forget_password'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span> <span class="na">class=</span><span class="s">"btn btn-default btn-block btn-sm"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="s1">'login.link.forget_password'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="nt">&lt;/a&gt;</span>
                                <span class="nt">&lt;/div&gt;</span>
                                <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"col-sm-6"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'front_register'</span><span class="p">)</span><span class="cp">}}</span><span class="s">"</span> <span class="na">class=</span><span class="s">"btn btn-default btn-block btn-sm"</span><span class="nt">&gt;&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-user"</span><span class="nt">&gt;&lt;/i&gt;</span> <span class="cp">{{</span> <span class="s1">'login.link.registration'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="nt">&lt;/a&gt;</span>
                                <span class="nt">&lt;/div&gt;</span>
                            <span class="nt">&lt;/div&gt;</span>
                        <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
                    <span class="nt">&lt;/form&gt;</span>
                <span class="nt">&lt;/div&gt;</span>
            <span class="nt">&lt;/div&gt;</span>
        <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span></code></pre></figure>

<p>Maintenant que nous avons implémenté toutes les fonctionnalités, nous pouvons ajouter le menu de navigation dans le front :</p>

<figure class="highlight"><pre><code class="language-twig" data-lang="twig"><span class="c">{# templates/front/block/_navbar.html.twig #}</span>
<span class="cp">{%</span> <span class="nv">trans_default_domain</span> <span class="s1">'front_message'</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">set</span> <span class="nv">route</span> <span class="err">=</span> <span class="nv">app.request.get</span><span class="p">(</span><span class="s1">'_route'</span><span class="p">)</span> <span class="cp">%}</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"navbar navbar-expand-md navbar-dark bg-dark mb-4"</span> <span class="na">role=</span><span class="s">"navigation"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"navbar-brand"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>DevFusion<span class="nt">&lt;/a&gt;</span>
    <span class="nt">&lt;button</span> <span class="na">class=</span><span class="s">"navbar-toggler"</span> <span class="na">type=</span><span class="s">"button"</span> <span class="na">data-toggle=</span><span class="s">"collapse"</span> <span class="na">data-target=</span><span class="s">"#navbarCollapse"</span> <span class="na">aria-controls=</span><span class="s">"navbarCollapse"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span> <span class="na">aria-label=</span><span class="s">"Toggle navigation"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">"navbar-toggler-icon"</span><span class="nt">&gt;&lt;/span&gt;</span>
    <span class="nt">&lt;/button&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"collapse navbar-collapse"</span> <span class="na">id=</span><span class="s">"navbarCollapse"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"navbar-nav mr-auto"</span><span class="nt">&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item</span><span class="cp">{{</span> <span class="nv">route</span> <span class="o">==</span> <span class="s1">'front_home'</span> <span class="err">?</span> <span class="s1">' active'</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link"</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="s1">'nav.home'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span><span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item"</span><span class="nt">&gt;</span>
                <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link"</span> <span class="na">href=</span><span class="s">""</span> <span class="na">target=</span><span class="s">"_blank"</span><span class="nt">&gt;</span>Github<span class="nt">&lt;/a&gt;</span>
            <span class="nt">&lt;/li&gt;</span>
            <span class="cp">{%</span> <span class="k">if</span> <span class="nv">app.user</span> <span class="cp">%}</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item dropdown"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link dropdown-toggle"</span> <span class="na">id=</span><span class="s">"dropdown_account"</span> 
                        <span class="na">data-toggle=</span><span class="s">"dropdown"</span> <span class="na">aria-haspopup=</span><span class="s">"true"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span>
                    <span class="nt">&gt;</span>
                        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-user"</span><span class="nt">&gt;&lt;/i&gt;</span> <span class="cp">{{</span> <span class="s1">'nav.account'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                    <span class="nt">&lt;/a&gt;</span>
                    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span> <span class="na">aria-labelledby=</span><span class="s">"dropdown_account"</span><span class="nt">&gt;</span>
                        <span class="cp">{%</span> <span class="k">if</span> <span class="nv">is_granted</span><span class="p">(</span><span class="s2">"ROLE_ADMIN"</span><span class="p">)</span> <span class="cp">%}</span>
                            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown-item"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'back_home'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-user-cog"</span><span class="nt">&gt;&lt;/i&gt;</span> <span class="cp">{{</span> <span class="s1">'nav.account_admin'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                                <span class="nt">&lt;/a&gt;</span>
                            <span class="nt">&lt;/li&gt;</span>
                        <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
                            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown-item"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"#"</span><span class="nt">&gt;</span>
                                    <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-user-cog"</span><span class="nt">&gt;&lt;/i&gt;</span> <span class="cp">{{</span> <span class="s1">'nav.account_profile'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                                <span class="nt">&lt;/a&gt;</span>
                            <span class="nt">&lt;/li&gt;</span>
                        <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
                        <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown-item</span><span class="cp">{{</span> <span class="nv">route</span> <span class="o">==</span> <span class="s1">'app_reset_password'</span> <span class="err">?</span> <span class="s1">' active'</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'app_reset_password'</span><span class="p">,</span> <span class="err">{</span> <span class="s1">'id'</span><span class="err">:</span> <span class="nv">app.user.id</span> <span class="err">}</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-"</span><span class="nt">&gt;&lt;/i&gt;</span> <span class="cp">{{</span> <span class="s1">'nav.account_reset_password'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                            <span class="nt">&lt;/a&gt;</span>
                        <span class="nt">&lt;/li&gt;</span>
                        <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown-item"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'app_logout'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-sign-out-alt"</span><span class="nt">&gt;&lt;/i&gt;</span> <span class="cp">{{</span> <span class="s1">'nav.account_logout'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                            <span class="nt">&lt;/a&gt;</span>
                        <span class="nt">&lt;/li&gt;</span>
                    <span class="nt">&lt;/ul&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
            <span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
                <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"nav-item dropdown"</span><span class="nt">&gt;</span>
                    <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">"nav-link dropdown-toggle"</span> <span class="na">id=</span><span class="s">"dropdown_account"</span> 
                        <span class="na">data-toggle=</span><span class="s">"dropdown"</span> <span class="na">aria-haspopup=</span><span class="s">"true"</span> <span class="na">aria-expanded=</span><span class="s">"false"</span>
                    <span class="nt">&gt;</span>
                        <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-user"</span><span class="nt">&gt;&lt;/i&gt;</span> <span class="cp">{{</span> <span class="s1">'nav.account'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                    <span class="nt">&lt;/a&gt;</span>
                    <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">"dropdown-menu"</span> <span class="na">aria-labelledby=</span><span class="s">"dropdown_account"</span><span class="nt">&gt;</span>
                        <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown-item</span><span class="cp">{{</span> <span class="nv">route</span> <span class="o">==</span> <span class="s1">'app_login'</span> <span class="err">?</span> <span class="s1">' active'</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'app_login'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-sign-in-alt"</span><span class="nt">&gt;&lt;/i&gt;</span> <span class="cp">{{</span> <span class="s1">'nav.account_login'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                            <span class="nt">&lt;/a&gt;</span>
                        <span class="nt">&lt;/li&gt;</span>
                        <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">"dropdown-item</span><span class="cp">{{</span> <span class="nv">route</span> <span class="o">==</span> <span class="s1">'front_register'</span> <span class="err">?</span> <span class="s1">' active'</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
                            <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">"</span><span class="cp">{{</span> <span class="nv">path</span><span class="p">(</span><span class="s1">'front_register'</span><span class="p">)</span> <span class="cp">}}</span><span class="s">"</span><span class="nt">&gt;</span>
                                <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"fas fa-user"</span><span class="nt">&gt;&lt;/i&gt;</span> <span class="cp">{{</span> <span class="s1">'nav.account_register'</span><span class="o">|</span><span class="nf">trans</span><span class="p">()</span> <span class="cp">}}</span>
                            <span class="nt">&lt;/a&gt;</span>
                        <span class="nt">&lt;/li&gt;</span>
                    <span class="nt">&lt;/ul&gt;</span>
                <span class="nt">&lt;/li&gt;</span>
            <span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
        <span class="nt">&lt;/ul&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span></code></pre></figure>

<h2 id="en-conclusion">En conclusion</h2>

<p>Nous avons finalement un espace utilisateur complet et fonctionnel. Grâce au symfony/maker-bundle, nous avons généré une bonne partie de l’application ce qui nous a grandement facilité la vie.</p>

<p>Vous pouvez retrouver les fichiers de traduction et tous les fichiers que je vous ai présentés dans <a href="https://github.com/official-dev-fusion/dev-fusion-skeleton-user">le repository Github du projet</a>.</p>

<p>Il manque seulement la gestion des utilisateurs du côté back-office. Nous allons voir cela dans un prochain tutoriel qui devrait venir rapidement. Ça ne devrait pas être très compliqué, car nous allons utiliser le devfusion/maker-bundle pour générer 90 % du code.</p>

<p>En espérant que tout cela vous sera utile.</p>

<p>Si vous rencontrer des bogues, des erreurs ou si vous avez des commentaires, vous pouvez m’en faire part à l’adresse martin.gilbert@dev-fusion.com.</p>


  </div>
</article>
</div>
</main>

        <footer class="container">

    <h2>DevFusion</h2>

    <div class="row">
      <div class="col-md-4">
        <ul class="contact-list">
          <li>
            
              DevFusion
            
            </li>
            
            <li><a href="mailto:martin.gilbert@dev-fusion.com">martin.gilbert@dev-fusion.com</a></li>
            
        </ul>
      </div>

      <div class="col-md-4">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/official-dev-fusion"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">official-dev-fusion</span></a>

          </li>
          

          
        </ul>
      </div>

      <div class="col-md-4">
        <p>Blogue d’un développeur fusion, réflexions, découvertes et tutoriels… Les différentes technos sont à la programmation ce que le funk, le blues et le rock sont au jazz fusion. Un moyen pour répondre à un besoin, il faut parfois les mixer pour donner la meilleure réponse.</p>
      </div>
    </div>

</footer>


        <script src="/assets/js/vendor/modernizr-3.5.0.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
        <script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-3.2.1.min.js"><\/script>')</script>
        <script src="/assets/js/plugins.js"></script>
        <script src="/assets/js/main.js"></script>

        <!-- Bootstrap 4 -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

        
  </body>
</html>